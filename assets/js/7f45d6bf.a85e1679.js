"use strict";(self.webpackChunkwoo_docs_migration=self.webpackChunkwoo_docs_migration||[]).push([[3975],{8453:(e,n,r)=>{r.d(n,{R:()=>s,x:()=>c});var t=r(6540);const o={},a=t.createContext(o);function s(e){const n=t.useContext(a);return t.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function c(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(o):e.components||o:s(e.components),t.createElement(a.Provider,{value:n},e.children)}},9821:(e,n,r)=>{r.r(n),r.d(n,{assets:()=>d,contentTitle:()=>c,default:()=>u,frontMatter:()=>s,metadata:()=>t,toc:()=>i});const t=JSON.parse('{"id":"features/analytics/extending-woocommerce-admin-reports","title":"How to extend WooCommerce analytics reports","description":"Introduction","source":"@site/../features/analytics/extending-woocommerce-admin-reports.md","sourceDirName":"features/analytics","slug":"/features/analytics/extending-woocommerce-admin-reports","permalink":"/docs/features/analytics/extending-woocommerce-admin-reports","draft":false,"unlisted":false,"editUrl":"https://github.com/woocommerce/woocommerce/tree/docusaurus-docs-prep/docs/docs/../features/analytics/extending-woocommerce-admin-reports.md","tags":[],"version":"current","frontMatter":{"post_title":"How to extend WooCommerce analytics reports","sidebar_label":"Extend analytics reports"},"sidebar":"docsSidebar","previous":{"title":"Add columns to analytics reports","permalink":"/docs/features/analytics/adding-columns-to-analytics-reports-and-csv-downloads"},"next":{"title":"HTML best practices","permalink":"/docs/features/email/email-html-best-practices"}}');var o=r(4848),a=r(8453);const s={post_title:"How to extend WooCommerce analytics reports",sidebar_label:"Extend analytics reports"},c="How to extend WooCommerce analytics reports",d={},i=[{value:"Introduction",id:"introduction",level:2},{value:"Getting started",id:"getting-started",level:2},{value:"Populating test data",id:"populating-test-data",level:2},{value:"Add a UI dropdown",id:"add-a-ui-dropdown",level:2},{value:"Handle currency parameters on the server",id:"handle-currency-parameters-on-the-server",level:2},{value:"Finishing touches",id:"finishing-touches",level:2},{value:"Conclusion",id:"conclusion",level:2}];function l(e){const n={a:"a",code:"code",h1:"h1",h2:"h2",header:"header",img:"img",p:"p",pre:"pre",...(0,a.R)(),...e.components};return(0,o.jsxs)(o.Fragment,{children:[(0,o.jsx)(n.header,{children:(0,o.jsx)(n.h1,{id:"how-to-extend-woocommerce-analytics-reports",children:"How to extend WooCommerce analytics reports"})}),"\n",(0,o.jsx)(n.h2,{id:"introduction",children:"Introduction"}),"\n",(0,o.jsx)(n.p,{children:"This document serves as a guide to extending WC-Admin Reports with a basic UI dropdown, added query parameters, and modification of SQL queries and resulting report data. This example will create a currency selector for viewing the Orders Report based on a specific currency."}),"\n",(0,o.jsxs)(n.p,{children:["Code from this guide can be viewed in the ",(0,o.jsx)(n.a,{href:"https://github.com/woocommerce/woocommerce-admin/tree/main/docs/examples/extensions/sql-modification",children:"wc-admin code repository"}),"."]}),"\n",(0,o.jsx)(n.h2,{id:"getting-started",children:"Getting started"}),"\n",(0,o.jsxs)(n.p,{children:["We'll be using a local installation of WordPress with WooCommerce and the development version of WC-Admin to take advantage of ",(0,o.jsx)(n.code,{children:"create-wc-extension"})," as a way to easily scaffold a modern WordPress JavaScript environment for plugins."]}),"\n",(0,o.jsx)(n.p,{children:"In your local install, clone and start WC-Admin if you haven't already."}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-sh",children:"cd wp-content/plugins\ngit clone git@github.com:woocommerce/woocommerce-admin.git\ncd woocommerce-admin\nnpm run build\n"})}),"\n",(0,o.jsx)(n.p,{children:"Once that's working, we can setup the extension folder ready for JavaScript development."}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-sh",children:"npm run create-wc-extension\n"})}),"\n",(0,o.jsx)(n.p,{children:"After choosing a name, move into that folder and start webpack to watch and build files."}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-sh",children:"cd ../<my-plugin-name>\nnpm install\nnpm start\n"})}),"\n",(0,o.jsxs)(n.p,{children:["Don't forget to head over to ",(0,o.jsx)(n.code,{children:"/wp-admin/plugins.php"})," and activate your plugin."]}),"\n",(0,o.jsx)(n.h2,{id:"populating-test-data",children:"Populating test data"}),"\n",(0,o.jsx)(n.p,{children:"Next, set up some orders to have sample data. Using WooCommerce > Settings > Currency, I added three test orders in Mexican Peso, US Dollar, and New Zealand Dollar."}),"\n",(0,o.jsxs)(n.p,{children:["After doing so, check out WC-Admin to make sure the orders are showing up by going to ",(0,o.jsx)(n.code,{children:"/wp-admin/admin.php?page=wc-admin&period=today&path=%2Fanalytics%2Forders&compare=previous_year"}),". Note that without any modification currency figures show according to what I have currently in WooCommerce settings, which is New Zealand Dollar in this case."]}),"\n",(0,o.jsx)(n.p,{children:(0,o.jsx)(n.img,{src:"https://developer.woocommerce.com/wp-content/uploads/2023/12/screen-shot-2020-02-19-at-12.11.34-pm.png?w=851",alt:"screenshot of wp-admin showing processing orders"})}),"\n",(0,o.jsxs)(n.p,{children:["We can confirm each order's currency by running the following query on the ",(0,o.jsx)(n.code,{children:"wp_posts"})," table and joining ",(0,o.jsx)(n.code,{children:"wp_postmeta"})," to gather currency meta values. Results show an order in NZD, USD, and MXN. This query is similar to the one we'll implement later in the guide to gather and display currency values."]}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-sql",children:"SELECT\n    ID,\n    post_name,\n    post_type,\n    currency_postmeta.meta_value AS currency\nFROM `wp_posts`\nJOIN wp_postmeta currency_postmeta ON wp_posts.ID = currency_postmeta.post_id\nWHERE currency_postmeta.meta_key = '_order_currency'\nORDER BY wp_posts.post_date DESC\nLIMIT 3\n"})}),"\n",(0,o.jsx)(n.p,{children:(0,o.jsx)(n.img,{src:"https://developer.woocommerce.com/wp-content/uploads/2023/12/screen-shot-2020-02-19-at-12.33.45-pm.png?w=756",alt:"screenshot of resulting query"})}),"\n",(0,o.jsx)(n.h2,{id:"add-a-ui-dropdown",children:"Add a UI dropdown"}),"\n",(0,o.jsxs)(n.p,{children:["In order to view reports in differing currencies, a filter or dropdown will be needed. We can add a basic filter to reports by adding a configuration object similar to ",(0,o.jsx)(n.a,{href:"https://github.com/woocommerce/woocommerce-admin/blob/main/client/analytics/report/orders/config.js#L50-L62",children:"this one from the Orders Report"}),"."]}),"\n",(0,o.jsxs)(n.p,{children:["First, we need to populate the client with data to render the dropdown. The best way to do this is to add data to the ",(0,o.jsx)(n.code,{children:"wcSettings"})," global. This global can be useful for transferring static configuration data from PHP to the client. In the main PHP file, add currency settings to the Data Registry to populate ",(0,o.jsx)(n.code,{children:"window.wcSettings.multiCurrency"}),"."]}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-php",children:"function add_currency_settings() {\n\t$currencies = array(\n\t\tarray(\n\t\t\t'label' => __( 'United States Dollar', 'dev-blog-example' ),\n\t\t\t'value' => 'USD',\n\t\t),\n\t\tarray(\n\t\t\t'label' => __( 'New Zealand Dollar', 'dev-blog-example' ),\n\t\t\t'value' => 'NZD',\n\t\t),\n\t\tarray(\n\t\t\t'label' => __( 'Mexican Peso', 'dev-blog-example' ),\n\t\t\t'value' => 'MXN',\n\t\t),\n\t);\n\n\t$data_registry = Automattic\\WooCommerce\\Blocks\\Package::container()->get(\n\t\tAutomattic\\WooCommerce\\Blocks\\Assets\\AssetDataRegistry::class\n\t);\n\n\t$data_registry->add( 'multiCurrency', $currencies );\n}\n\nadd_action( 'init', 'add_currency_settings' );\n"})}),"\n",(0,o.jsx)(n.p,{children:"In the console, you can confirm the data has safely made its way to the client."}),"\n",(0,o.jsx)(n.p,{children:(0,o.jsx)(n.img,{src:"https://developer.woocommerce.com/wp-content/uploads/2023/12/screen-shot-2020-02-19-at-1.11.50-pm.png?w=476",alt:"screnshot of console"})}),"\n",(0,o.jsxs)(n.p,{children:["In ",(0,o.jsx)(n.code,{children:"index.js"})," create the custom currency filter and add it the Orders Report."]}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-js",children:'import { addFilter } from "@wordpress/hooks";\nimport { __ } from "@wordpress/i18n";\n\nconst addCurrencyFilters = (filters) => {\n  return [\n    {\n      label: __("Currency", "dev-blog-example"),\n      staticParams: [],\n      param: "currency",\n      showFilters: () => true,\n      defaultValue: "USD",\n      filters: [...(wcSettings.multiCurrency || [])],\n    },\n    ...filters,\n  ];\n};\n\naddFilter(\n  "woocommerce_admin_orders_report_filters",\n  "dev-blog-example",\n  addCurrencyFilters\n);\n'})}),"\n",(0,o.jsxs)(n.p,{children:["If we check out the Orders Report, we can see our new dropdown. Play around with it and you'll notice the currency query parameter gets added to the url. If you check out the Network tab, you'll also see this value included in requests for data used to populate the report. For example, see the requests to orders stats endpoint, ",(0,o.jsx)(n.code,{children:"/wp-json/wc-analytics/reports/orders/stats"}),". Next we'll use that query parameter to adjust report results."]}),"\n",(0,o.jsx)(n.p,{children:(0,o.jsx)(n.img,{src:"https://developer.woocommerce.com/wp-content/uploads/2023/12/screen-shot-2020-02-19-at-1.16.44-pm.png?w=512",alt:"screenshot showing UI dropdown in wp-admin"})}),"\n",(0,o.jsx)(n.h2,{id:"handle-currency-parameters-on-the-server",children:"Handle currency parameters on the server"}),"\n",(0,o.jsxs)(n.p,{children:["Now that our dropdown adds a ",(0,o.jsx)(n.code,{children:"currency"})," query parameter to requests for data, the first thing we'll need to do is add the parameter as a query argument to the Orders Data Store and Orders Stats Data Store. Those data stores use query arguments for caching purposes, so by adding our parameter we can be sure a new database query will be performed when the parameter changes. Add the query argument in your main PHP file."]}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-php",children:"function apply_currency_arg( $args ) {\n\t$currency = 'USD';\n\n\tif ( isset( $_GET['currency'] ) ) {\n\t\t$currency = sanitize_text_field( wp_unslash( $_GET['currency'] ) );\n\t}\n\n\t$args['currency'] = $currency;\n\n\treturn $args;\n}\n\nadd_filter( 'woocommerce_analytics_orders_query_args', 'apply_currency_arg' );\nadd_filter( 'woocommerce_analytics_orders_stats_query_args', 'apply_currency_arg' );\n"})}),"\n",(0,o.jsxs)(n.p,{children:["Now that we're sure a new database query is performed on mutations of the ",(0,o.jsx)(n.code,{children:"currency"})," query parameter, we can start adding SQL statements to the queries that gather data."]}),"\n",(0,o.jsx)(n.p,{children:"Lets start by adding a JOIN for the orders table, orders stats, and orders chart."}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-php",children:"function add_join_subquery( $clauses ) {\n\tglobal $wpdb;\n\n\t$clauses[] = \"JOIN {$wpdb->postmeta} currency_postmeta ON {$wpdb->prefix}wc_order_stats.order_id = currency_postmeta.post_id\";\n\n\treturn $clauses;\n}\n\nadd_filter( 'woocommerce_analytics_clauses_join_orders_subquery', 'add_join_subquery' );\nadd_filter( 'woocommerce_analytics_clauses_join_orders_stats_total', 'add_join_subquery' );\nadd_filter( 'woocommerce_analytics_clauses_join_orders_stats_interval', 'add_join_subquery' );\n"})}),"\n",(0,o.jsx)(n.p,{children:"Next, add a WHERE clause"}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-php",children:"function add_where_subquery( $clauses ) {\n\t$currency = 'USD';\n\n\tif ( isset( $_GET['currency'] ) ) {\n\t\t$currency = sanitize_text_field( wp_unslash( $_GET['currency'] ) );\n\t}\n\n\t$clauses[] = \"AND currency_postmeta.meta_key = '_order_currency' AND currency_postmeta.meta_value = '{$currency}'\";\n\n\treturn $clauses;\n}\n\nadd_filter( 'woocommerce_analytics_clauses_where_orders_subquery', 'add_where_subquery' );\nadd_filter( 'woocommerce_analytics_clauses_where_orders_stats_total', 'add_where_subquery' );\nadd_filter( 'woocommerce_analytics_clauses_where_orders_stats_interval', 'add_where_subquery' );\n"})}),"\n",(0,o.jsx)(n.p,{children:"And finally, a SELECT clause."}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-php",children:"function add_select_subquery( $clauses ) {\n\t$clauses[] = ', currency_postmeta.meta_value AS currency';\n\n\treturn $clauses;\n}\n\nadd_filter( 'woocommerce_analytics_clauses_select_orders_subquery', 'add_select_subquery' );\nadd_filter( 'woocommerce_analytics_clauses_select_orders_stats_total', 'add_select_subquery' );\nadd_filter( 'woocommerce_analytics_clauses_select_orders_stats_interval', 'add_select_subquery' );\n"})}),"\n",(0,o.jsx)(n.p,{children:"Lets head back to the Orders Report and see if it works. You can manipulate the dropdown and see the relevant order reflected in the table."}),"\n",(0,o.jsx)(n.p,{children:(0,o.jsx)(n.img,{src:"https://developer.woocommerce.com/wp-content/uploads/2023/12/screen-shot-2020-02-19-at-1.38.54-pm.png?w=585",alt:"screenshot of WooCommerce Orders tab in wp-admin showing the relevant order reflected in the table."})}),"\n",(0,o.jsx)(n.h2,{id:"finishing-touches",children:"Finishing touches"}),"\n",(0,o.jsxs)(n.p,{children:["The orders table could use some customisation to reflect the selected currency. We can add a column to display the currency in ",(0,o.jsx)(n.code,{children:"index.js"}),". The ",(0,o.jsx)(n.code,{children:"reportTableData"})," argument is an object of headers, rows, and items, which are arrays of data. We'll need to add a new header and append the currency to each row's data array."]}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-js",children:'const addTableColumn = (reportTableData) => {\n  if ("orders" !== reportTableData.endpoint) {\n    return reportTableData;\n  }\n\n  const newHeaders = [\n    {\n      label: "Currency",\n      key: "currency",\n    },\n    ...reportTableData.headers,\n  ];\n  const newRows = reportTableData.rows.map((row, index) => {\n    const item = reportTableData.items.data[index];\n    const newRow = [\n      {\n        display: item.currency,\n        value: item.currency,\n      },\n      ...row,\n    ];\n    return newRow;\n  });\n\n  reportTableData.headers = newHeaders;\n  reportTableData.rows = newRows;\n\n  return reportTableData;\n};\n\naddFilter("woocommerce_admin_report_table", "dev-blog-example", addTableColumn);\n'})}),"\n",(0,o.jsx)(n.p,{children:(0,o.jsx)(n.img,{src:"https://developer.woocommerce.com/wp-content/uploads/2023/12/screen-shot-2020-02-19-at-4.02.15-pm.png?w=861",alt:"screenshot of customized table"})}),"\n",(0,o.jsx)(n.p,{children:"While adding a column is certainly helpful, currency figures in the table and chart only reflect the store currency."}),"\n",(0,o.jsx)(n.p,{children:(0,o.jsx)(n.img,{src:"https://developer.woocommerce.com/wp-content/uploads/2023/12/screen-shot-2020-02-19-at-4.03.42-pm.png?w=865",alt:"screenshot of report"})}),"\n",(0,o.jsxs)(n.p,{children:["In order to change a Report's currency and number formatting, we can make use of the ",(0,o.jsx)(n.code,{children:"woocommerce_admin_report_currency"})," JS hook. You can see the store's default sent to the client in ",(0,o.jsx)(n.code,{children:"wcSettings.currency"}),", but we'll need to change these depending on the currency being viewed and designated by the query parameter ",(0,o.jsx)(n.code,{children:"?currency=NZD"}),"."]}),"\n",(0,o.jsx)(n.p,{children:(0,o.jsx)(n.img,{src:"https://developer.woocommerce.com/wp-content/uploads/2023/12/screen-shot-2020-04-03-at-11.18.42-am.png?w=238",alt:"screenshot of currency settings"})}),"\n",(0,o.jsx)(n.p,{children:"First, lets create some configs in index.js."}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-js",children:'const currencies = {\n  MXN: {\n    code: "MXN",\n    symbol: "$MXN", // For the sake of the example.\n    symbolPosition: "left",\n    thousandSeparator: ",",\n    decimalSeparator: ".",\n    precision: 2,\n  },\n  NZD: {\n    code: "NZD",\n    symbol: "$NZ",\n    symbolPosition: "left",\n    thousandSeparator: ",",\n    decimalSeparator: ".",\n    precision: 2,\n  },\n};\n'})}),"\n",(0,o.jsx)(n.p,{children:"Finally, add our function to the hook which applies a config based on the currency query parameter."}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-js",children:'const updateReportCurrencies = (config, { currency }) => {\n  if (currency && currencies[currency]) {\n    return currencies[currency];\n  }\n  return config;\n};\n\naddFilter(\n  "woocommerce_admin_report_currency",\n  "dev-blog-example",\n  updateReportCurrencies\n);\n'})}),"\n",(0,o.jsx)(n.p,{children:"\ud83c\udf89 We can now view our Orders Report and see the currency reflected in monetary values throughout the report."}),"\n",(0,o.jsx)(n.p,{children:(0,o.jsx)(n.img,{src:"https://developer.woocommerce.com/wp-content/uploads/2023/12/screen-shot-2020-04-03-at-11.29.05-am.png?w=912",alt:"Screenshot of customized order report"})}),"\n",(0,o.jsx)(n.h2,{id:"conclusion",children:"Conclusion"}),"\n",(0,o.jsx)(n.p,{children:"In this guide, we added a UI element to manipulate query parameters sent to the server and used those values to modify SQL statements which gather report data. In doing so, we established a way to highly customise WC-Admin reports. Hopefully this example illustrates how the platform can be tailored by extensions to bring a powerful experience to users."})]})}function u(e={}){const{wrapper:n}={...(0,a.R)(),...e.components};return n?(0,o.jsx)(n,{...e,children:(0,o.jsx)(l,{...e})}):l(e)}}}]);