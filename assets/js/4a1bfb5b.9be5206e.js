"use strict";(self.webpackChunkwoo_docs_migration=self.webpackChunkwoo_docs_migration||[]).push([[3454],{4497:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>d,contentTitle:()=>c,default:()=>h,frontMatter:()=>r,metadata:()=>s,toc:()=>i});const s=JSON.parse('{"id":"best-practices/data-management/crud-objects","title":"Developing using WooCommerce CRUD objects","description":"CRUD is an abbreviation of the four basic operations you can do to a database or resource - Create, Read, Update, Delete.","source":"@site/../best-practices/data-management/crud-objects.md","sourceDirName":"best-practices/data-management","slug":"/best-practices/data-management/crud-objects","permalink":"/docs/best-practices/data-management/crud-objects","draft":false,"unlisted":false,"editUrl":"https://github.com/woocommerce/woocommerce/tree/docusaurus-docs-prep/docs/docs/../best-practices/data-management/crud-objects.md","tags":[],"version":"current","frontMatter":{"post_title":"Developing using WooCommerce CRUD objects","sidebar_label":"Using CRUD objects"},"sidebar":"docsSidebar","previous":{"title":"Add custom fields to products","permalink":"/docs/best-practices/data-management/adding-a-custom-field-to-variable-products"},"next":{"title":"Data storage","permalink":"/docs/best-practices/data-management/data-storage"}}');var a=n(4848),o=n(8453);const r={post_title:"Developing using WooCommerce CRUD objects",sidebar_label:"Using CRUD objects"},c="Developing using WooCommerce CRUD objects",d={},i=[{value:"The benefits of CRUD",id:"the-benefits-of-crud",level:2},{value:"CRUD object structure",id:"crud-object-structure",level:2},{value:"Data",id:"data",level:3},{value:"Getters and setters",id:"getters-and-setters",level:3},{value:"The constructor",id:"the-constructor",level:3},{value:"Saving and deleting",id:"saving-and-deleting",level:3},{value:"CRUD usage examples",id:"crud-usage-examples",level:2},{value:"Creating a new simple product",id:"creating-a-new-simple-product",level:3},{value:"Updating an existing coupon",id:"updating-an-existing-coupon",level:3},{value:"Retrieving a customer",id:"retrieving-a-customer",level:3}];function l(e){const t={a:"a",code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",li:"li",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,o.R)(),...e.components};return(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)(t.header,{children:(0,a.jsx)(t.h1,{id:"developing-using-woocommerce-crud-objects",children:"Developing using WooCommerce CRUD objects"})}),"\n",(0,a.jsx)(t.p,{children:"CRUD is an abbreviation of the four basic operations you can do to a database or resource - Create, Read, Update, Delete."}),"\n",(0,a.jsxs)(t.p,{children:[(0,a.jsx)(t.a,{href:"https://woocommerce.wordpress.com/2016/10/27/the-new-crud-classes-in-woocommerce-2-7/",children:"WooCommerce 3.0 introduced CRUD objects"})," for working with WooCommerce data. ",(0,a.jsx)(t.strong,{children:"Whenever possible these objects should be used in your code instead of directly updating metadata or using WordPress post objects."})]}),"\n",(0,a.jsx)(t.p,{children:"Each of these objects contains a schema for the data it controls (properties), a getter and setter for each property, and a save/delete method which talks to a data store. The data store handles the actual saving/reading from the database. The object itself does not need to be aware of where the data is stored."}),"\n",(0,a.jsx)(t.h2,{id:"the-benefits-of-crud",children:"The benefits of CRUD"}),"\n",(0,a.jsxs)(t.ul,{children:["\n",(0,a.jsx)(t.li,{children:"Structure - Each object has a pre-defined structure and keeps its own data valid."}),"\n",(0,a.jsx)(t.li,{children:"Control - We control the flow of data, and any validation needed, so we know when changes occur."}),"\n",(0,a.jsx)(t.li,{children:"Ease of development - As a developer, you don't need to know the internals of the data you're working with, just the names."}),"\n",(0,a.jsx)(t.li,{children:"Abstraction - The data can be moved elsewhere, e.g. custom tables, without affecting existing code."}),"\n",(0,a.jsx)(t.li,{children:"Unification - We can use the same code for updating things in admin as we do in the REST API and CLIs. Everything is unified."}),"\n",(0,a.jsx)(t.li,{children:"Simplified code - Less procedural code to update objects which reduces likelihood of malfunction and adds more unit test coverage."}),"\n"]}),"\n",(0,a.jsx)(t.h2,{id:"crud-object-structure",children:"CRUD object structure"}),"\n",(0,a.jsxs)(t.p,{children:["The ",(0,a.jsx)(t.a,{href:"https://github.com/woocommerce/woocommerce/blob/trunk/plugins/woocommerce/includes/abstracts/abstract-wc-data.php",children:(0,a.jsx)(t.code,{children:"WC_Data"})})," class is the basic implementation for CRUD objects, and all CRUD objects extend it. The most important properties to note are ",(0,a.jsx)(t.code,{children:"$data"}),", which is an array of props supported in each object, and ",(0,a.jsx)(t.code,{children:"$id"}),", which is the object's ID."]}),"\n",(0,a.jsxs)(t.p,{children:["The ",(0,a.jsx)(t.a,{href:"https://github.com/woocommerce/woocommerce/blob/trunk/plugins/woocommerce/includes/class-wc-coupon.php",children:"coupon object class"})," is a good example of extending ",(0,a.jsx)(t.code,{children:"WC_Data"})," and adding CRUD functions to all properties."]}),"\n",(0,a.jsx)(t.h3,{id:"data",children:"Data"}),"\n",(0,a.jsxs)(t.p,{children:[(0,a.jsx)(t.code,{children:"$data"})," stores the property names, and default values:"]}),"\n",(0,a.jsx)(t.pre,{children:(0,a.jsx)(t.code,{className:"language-php",children:"/**\n * Data array, with defaults.\n * @since 3.0.0\n * @var array\n */\nprotected $data = array(\n\t'code'                        => '',\n\t'amount'                      => 0,\n\t'date_created'                => '',\n\t'date_modified'               => '',\n\t'discount_type'               => 'fixed_cart',\n\t'description'                 => '',\n\t'date_expires'                => '',\n\t'usage_count'                 => 0,\n\t'individual_use'              => false,\n\t'product_ids'                 => array(),\n\t'excluded_product_ids'        => array(),\n\t'usage_limit'                 => 0,\n\t'usage_limit_per_user'        => 0,\n\t'limit_usage_to_x_items'      => 0,\n\t'free_shipping'               => false,\n\t'product_categories'          => array(),\n\t'excluded_product_categories' => array(),\n\t'exclude_sale_items'          => false,\n\t'minimum_amount'              => '',\n\t'maximum_amount'              => '',\n\t'email_restrictions'          => array(),\n\t'used_by'                     => array(),\n);\n"})}),"\n",(0,a.jsx)(t.h3,{id:"getters-and-setters",children:"Getters and setters"}),"\n",(0,a.jsxs)(t.p,{children:["Each one of the keys in this array (property) has a getter and setter, e.g. ",(0,a.jsx)(t.code,{children:"set_used_by()"})," and ",(0,a.jsx)(t.code,{children:"get_used_by()"}),". ",(0,a.jsx)(t.code,{children:"$data"})," itself is private, so the getters and setters must be used to access the data."]}),"\n",(0,a.jsx)(t.p,{children:"Example getter:"}),"\n",(0,a.jsx)(t.pre,{children:(0,a.jsx)(t.code,{className:"language-php",children:"/**\n * Get records of all users who have used the current coupon.\n * @since  3.0.0\n * @param  string $context\n * @return array\n */\npublic function get_used_by( $context = 'view' ) {\n\treturn $this->get_prop( 'used_by', $context );\n}\n"})}),"\n",(0,a.jsx)(t.p,{children:"Example setter:"}),"\n",(0,a.jsx)(t.pre,{children:(0,a.jsx)(t.code,{className:"language-php",children:"/**\n * Set which users have used this coupon.\n * @since 3.0.0\n * @param array $used_by\n * @throws WC_Data_Exception\n */\npublic function set_used_by( $used_by ) {\n\t$this->set_prop( 'used_by', array_filter( $used_by ) );\n}\n"})}),"\n",(0,a.jsxs)(t.p,{children:[(0,a.jsx)(t.code,{children:"set_prop"})," and ",(0,a.jsx)(t.code,{children:"get_prop"})," are part of ",(0,a.jsx)(t.code,{children:"WC_Data"}),". These apply various filters (based on context) and handle changes, so we can efficiently save only the props that have changed rather than all props."]}),"\n",(0,a.jsxs)(t.p,{children:["A note on ",(0,a.jsx)(t.code,{children:"$context"}),": when getting data for use on the front end or display, ",(0,a.jsx)(t.code,{children:"view"})," context is used. This applies filters to the data so extensions can change the values dynamically. ",(0,a.jsx)(t.code,{children:"edit"})," context should be used when showing values to edit in the backend, and for saving to the database. Using ",(0,a.jsx)(t.code,{children:"edit"})," context does not apply any filters to the data."]}),"\n",(0,a.jsx)(t.h3,{id:"the-constructor",children:"The constructor"}),"\n",(0,a.jsx)(t.p,{children:"The constructor of the CRUD objects facilitates the read from the database. The actual read is not done by the CRUD class, but by its data store."}),"\n",(0,a.jsx)(t.p,{children:"Example:"}),"\n",(0,a.jsx)(t.pre,{children:(0,a.jsx)(t.code,{className:"language-php",children:"/**\n * Coupon constructor. Loads coupon data.\n * @param mixed $data Coupon data, object, ID or code.\n */\npublic function __construct( $data = '' ) {\n\tparent::__construct( $data );\n\n\tif ( $data instanceof WC_Coupon ) {\n\t\t$this->set_id( absint( $data->get_id() ) );\n\t} elseif ( is_numeric( $data ) && 'shop_coupon' === get_post_type( $data ) ) {\n\t\t$this->set_id( $data );\n\t} elseif ( ! empty( $data ) ) {\n\t\t$this->set_id( wc_get_coupon_id_by_code( $data ) );\n\t\t$this->set_code( $data );\n\t} else {\n\t\t$this->set_object_read( true );\n\t}\n\n\t$this->data_store = WC_Data_Store::load( 'coupon' );\n\tif ( $this->get_id() > 0 ) {\n\t\t$this->data_store->read( $this );\n\t}\n}\n"})}),"\n",(0,a.jsxs)(t.p,{children:["Note how it sets the ID based on the data passed to the object, then calls the data store to retrieve the data from the database. Once the data is read via the data store, or if no ID is set, ",(0,a.jsx)(t.code,{children:"$this->set_object_read( true );"})," is set so the data store and CRUD object knows it's read. Once this is set, changes are tracked."]}),"\n",(0,a.jsx)(t.h3,{id:"saving-and-deleting",children:"Saving and deleting"}),"\n",(0,a.jsxs)(t.p,{children:["Save and delete methods are optional on CRUD child classes because the ",(0,a.jsx)(t.code,{children:"WC_Data"})," parent class can handle it. When ",(0,a.jsx)(t.code,{children:"save"})," is called, the data store is used to store data to the database. Delete removes the object from the database. ",(0,a.jsx)(t.code,{children:"save"})," must be called for changes to persist, otherwise they will be discarded."]}),"\n",(0,a.jsxs)(t.p,{children:["The save method in ",(0,a.jsx)(t.code,{children:"WC_Data"})," looks like this:"]}),"\n",(0,a.jsx)(t.pre,{children:(0,a.jsx)(t.code,{className:"language-php",children:"/**\n * Save should create or update based on object existence.\n *\n * @since  2.6.0\n * @return int\n */\npublic function save() {\n\tif ( $this->data_store ) {\n\t\t// Trigger action before saving to the DB. Allows you to adjust object props before save.\n\t\tdo_action( 'woocommerce_before_' . $this->object_type . '_object_save', $this, $this->data_store );\n\n\t\tif ( $this->get_id() ) {\n\t\t\t$this->data_store->update( $this );\n\t\t} else {\n\t\t\t$this->data_store->create( $this );\n\t\t}\n\t\treturn $this->get_id();\n\t}\n}\n"})}),"\n",(0,a.jsx)(t.p,{children:"Update/create is used depending on whether the object has an ID yet. The ID will be set after creation."}),"\n",(0,a.jsx)(t.p,{children:"The delete method is like this:"}),"\n",(0,a.jsx)(t.pre,{children:(0,a.jsx)(t.code,{className:"language-php",children:"/**\n * Delete an object, set the ID to 0, and return result.\n *\n * @since  2.6.0\n * @param  bool $force_delete\n * @return bool result\n */\npublic function delete( $force_delete = false ) {\n\tif ( $this->data_store ) {\n\t\t$this->data_store->delete( $this, array( 'force_delete' => $force_delete ) );\n\t\t$this->set_id( 0 );\n\t\treturn true;\n\t}\n\treturn false;\n}\n"})}),"\n",(0,a.jsx)(t.h2,{id:"crud-usage-examples",children:"CRUD usage examples"}),"\n",(0,a.jsx)(t.h3,{id:"creating-a-new-simple-product",children:"Creating a new simple product"}),"\n",(0,a.jsx)(t.pre,{children:(0,a.jsx)(t.code,{className:"language-php",children:"$product = new WC_Product_Simple();\n$product->set_name( 'My Product' );\n$product->set_slug( 'myproduct' );\n$product->set_description( 'A new simple product' );\n$product->set_regular_price( '9.50' );\n$product->save();\n\n$product_id = $product->get_id();\n"})}),"\n",(0,a.jsx)(t.h3,{id:"updating-an-existing-coupon",children:"Updating an existing coupon"}),"\n",(0,a.jsx)(t.pre,{children:(0,a.jsx)(t.code,{className:"language-php",children:"$coupon = new WC_Coupon( $coupon_id );\n$coupon->set_discount_type( 'percent' );\n$coupon->set_amount( 25.00 );\n$coupon->save();\n"})}),"\n",(0,a.jsx)(t.h3,{id:"retrieving-a-customer",children:"Retrieving a customer"}),"\n",(0,a.jsx)(t.pre,{children:(0,a.jsx)(t.code,{className:"language-php",children:"$customer = new WC_Customer( $user_id );\n$email    = $customer->get_email();\n$address  = $customer->get_billing_address();\n$name     = $customer->get_first_name() . ' ' . $customer->get_last_name();\n"})})]})}function h(e={}){const{wrapper:t}={...(0,o.R)(),...e.components};return t?(0,a.jsx)(t,{...e,children:(0,a.jsx)(l,{...e})}):l(e)}},8453:(e,t,n)=>{n.d(t,{R:()=>r,x:()=>c});var s=n(6540);const a={},o=s.createContext(a);function r(e){const t=s.useContext(o);return s.useMemo((function(){return"function"==typeof e?e(t):{...t,...e}}),[t,e])}function c(e){let t;return t=e.disableParentContext?"function"==typeof e.components?e.components(a):e.components||a:r(e.components),s.createElement(o.Provider,{value:t},e.children)}}}]);