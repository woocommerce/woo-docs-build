"use strict";(self.webpackChunkwoo_docs_migration=self.webpackChunkwoo_docs_migration||[]).push([[2318],{7540:(e,t,a)=>{a.r(t),a.d(t,{assets:()=>d,contentTitle:()=>i,default:()=>h,frontMatter:()=>r,metadata:()=>n,toc:()=>c});const n=JSON.parse('{"id":"features/payments/payment-gateway-api","title":"WooCommerce Payment Gateway API","description":"Payment gateways in WooCommerce are class based and can be added through traditional plugins. This guide provides an intro to gateway development.","source":"@site/../features/payments/payment-gateway-api.md","sourceDirName":"features/payments","slug":"/features/payments/payment-gateway-api","permalink":"/docs/features/payments/payment-gateway-api","draft":false,"unlisted":false,"editUrl":"https://github.com/woocommerce/woocommerce/tree/docusaurus-docs-prep/docs/docs/../features/payments/payment-gateway-api.md","tags":[],"version":"current","frontMatter":{"post_title":"WooCommerce Payment Gateway API","sidebar_label":"Payment Gateway API"},"sidebar":"docsSidebar","previous":{"title":"Low-code tools","permalink":"/docs/getting-started/tools-for-low-code-development"},"next":{"title":"WooCommerce payment gateway plugin base","permalink":"/docs/features/payments/payment-gateway-plugin-base"}}');var s=a(4848),o=a(8453);const r={post_title:"WooCommerce Payment Gateway API",sidebar_label:"Payment Gateway API"},i="WooCommerce Payment Gateway API",d={},c=[{value:"Types of payment gateway",id:"types-of-payment-gateway",level:2},{value:"Creating a basic payment gateway",id:"creating-a-basic-payment-gateway",level:2},{value:"Required Methods",id:"required-methods",level:3},{value:"__construct()",id:"__construct",level:4},{value:"init_form_fields()",id:"init_form_fields",level:4},{value:"process_payment( $order_id )",id:"process_payment-order_id-",level:4},{value:"Updating Order Status and Adding Notes",id:"updating-order-status-and-adding-notes",level:3},{value:"Order Status Best Practice",id:"order-status-best-practice",level:3},{value:"Notes on Direct Gateways",id:"notes-on-direct-gateways",level:2},{value:"Working with Payment Gateway Callbacks (such as PayPal IPN)",id:"working-with-payment-gateway-callbacks-such-as-paypal-ipn",level:2},{value:"Hooks in Gateways",id:"hooks-in-gateways",level:2}];function l(e){const t={a:"a",code:"code",em:"em",h1:"h1",h2:"h2",h3:"h3",h4:"h4",header:"header",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,o.R)(),...e.components};return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(t.header,{children:(0,s.jsx)(t.h1,{id:"woocommerce-payment-gateway-api",children:"WooCommerce Payment Gateway API"})}),"\n",(0,s.jsx)(t.p,{children:"Payment gateways in WooCommerce are class based and can be added through traditional plugins. This guide provides an intro to gateway development."}),"\n",(0,s.jsx)(t.h2,{id:"types-of-payment-gateway",children:"Types of payment gateway"}),"\n",(0,s.jsx)(t.p,{children:"Payment gateways come in several varieties:"}),"\n",(0,s.jsxs)(t.ol,{children:["\n",(0,s.jsxs)(t.li,{children:[(0,s.jsx)(t.strong,{children:"Form based"})," - This is where the user must click a button on a form that then redirects them to the payment processor on the gateway's own website. ",(0,s.jsx)(t.em,{children:"Example"}),": PayPal standard, Authorize.net DPM"]}),"\n",(0,s.jsxs)(t.li,{children:[(0,s.jsx)(t.strong,{children:"iFrame based"})," - This is when the gateway payment system is loaded inside an iframe on your store. ",(0,s.jsx)(t.em,{children:"Example"}),": SagePay Form, PayPal Advanced"]}),"\n",(0,s.jsxs)(t.li,{children:[(0,s.jsx)(t.strong,{children:"Direct"})," - This is when the payment fields are shown directly on the checkout page and the payment is made when 'place order' is pressed. ",(0,s.jsx)(t.em,{children:"Example"}),": PayPal Pro, Authorize.net AIM"]}),"\n",(0,s.jsxs)(t.li,{children:[(0,s.jsx)(t.strong,{children:"Offline"})," - No online payment is made. ",(0,s.jsx)(t.em,{children:"Example"}),": Cheque, Bank Transfer"]}),"\n"]}),"\n",(0,s.jsxs)(t.p,{children:["Form and iFrame based gateways post data offsite, meaning there are less security issues for you to think about. Direct gateways, however, require server security to be implemented (",(0,s.jsx)(t.a,{href:"https://woocommerce.com/document/ssl-and-https/",children:"SSL certificates"}),", etc.) and may also require a level of ",(0,s.jsx)(t.a,{href:"https://woocommerce.com/document/pci-dss-compliance-and-woocommerce/",children:"PCI compliance"}),"."]}),"\n",(0,s.jsx)(t.h2,{id:"creating-a-basic-payment-gateway",children:"Creating a basic payment gateway"}),"\n",(0,s.jsxs)(t.p,{children:[(0,s.jsx)(t.strong,{children:"Note:"})," The instructions below are for the default Checkout page. If you're looking to add a custom payment method for the new Checkout block, check out ",(0,s.jsx)(t.a,{href:"/docs/block-development/cart-and-checkout-blocks/checkout-payment-methods/payment-method-integration",children:"the payment method integration documentation"}),"."]}),"\n",(0,s.jsx)(t.p,{children:"Payment gateways should be created as additional plugins that hook into WooCommerce. Inside the plugin, you need to create a class after plugins are loaded. Example:"}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{className:"language-php",children:"add_action( 'plugins_loaded', 'init_your_gateway_class' );\n"})}),"\n",(0,s.jsxs)(t.p,{children:["It is also important that your gateway class extends the WooCommerce base gateway class, so you have access to important methods and the ",(0,s.jsx)(t.a,{href:"https://developer.woocommerce.com/docs/settings-api/",children:"settings API"}),":"]}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{className:"language-php",children:"function init_your_gateway_class() {\nclass WC_Gateway_Your_Gateway extends WC_Payment_Gateway {}\n}\n"})}),"\n",(0,s.jsxs)(t.p,{children:["You can view the ",(0,s.jsx)(t.a,{href:"https://woocommerce.github.io/code-reference/classes/WC-Payment-Gateway.html",children:"WC_Payment_Gateway class in the API Docs"}),"."]}),"\n",(0,s.jsxs)(t.p,{children:["As well as defining your class, you need to also tell WooCommerce (WC) that it exists. Do this by filtering ",(0,s.jsx)(t.em,{children:"woocommerce_payment_gateways"}),":"]}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{className:"language-php",children:"function add_your_gateway_class( $methods ) {\n$methods\\[\\] = 'WC_Gateway_Your_Gateway';\nreturn $methods;\n}\n"})}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{className:"language-php",children:"add_filter( 'woocommerce_payment_gateways', 'add_your_gateway_class' );\n"})}),"\n",(0,s.jsx)(t.h3,{id:"required-methods",children:"Required Methods"}),"\n",(0,s.jsx)(t.p,{children:"Most methods are inherited from the WC_Payment_Gateway class, but some are required in your custom gateway."}),"\n",(0,s.jsx)(t.h4,{id:"__construct",children:"__construct()"}),"\n",(0,s.jsx)(t.p,{children:"Within your constructor, you should define the following variables:"}),"\n",(0,s.jsxs)(t.ul,{children:["\n",(0,s.jsxs)(t.li,{children:[(0,s.jsx)(t.code,{children:"$this->id"})," - Unique ID for your gateway, e.g., 'your_gateway'"]}),"\n",(0,s.jsxs)(t.li,{children:[(0,s.jsx)(t.code,{children:"$this->icon"})," - If you want to show an image next to the gateway's name on the frontend, enter a URL to an image."]}),"\n",(0,s.jsxs)(t.li,{children:[(0,s.jsx)(t.code,{children:"$this->has_fields"})," - Bool. Can be set to true if you want payment fields to show on the checkout (if doing a direct integration)."]}),"\n",(0,s.jsxs)(t.li,{children:[(0,s.jsx)(t.code,{children:"$this->method_title"})," - Title of the payment method shown on the admin page."]}),"\n",(0,s.jsxs)(t.li,{children:[(0,s.jsx)(t.code,{children:"$this->method_description"})," - Description for the payment method shown on the admin page."]}),"\n"]}),"\n",(0,s.jsx)(t.p,{children:"Your constructor should also define and load settings fields:"}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{className:"language-php",children:"$this->init\\_form\\_fields();\n$this->init_settings();\n"})}),"\n",(0,s.jsxs)(t.p,{children:["We'll cover ",(0,s.jsx)(t.code,{children:"init_form_fields()"})," later, but this basically defines your settings that are then loaded with ",(0,s.jsx)(t.code,{children:"init_settings()"}),"."]}),"\n",(0,s.jsxs)(t.p,{children:["After ",(0,s.jsx)(t.code,{children:"init_settings()"})," is called, you can get the settings and load them into variables, meaning:"]}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{className:"language-php",children:"$this->title = $this->get_option( 'title' );\n"})}),"\n",(0,s.jsx)(t.p,{children:"Finally, you need to add a save hook for your settings:"}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{className:"language-php",children:"add_action( 'woocommerce_update_options_payment_gateways\\_' . $this->id, array( $this, 'process_admin_options' ) );\n"})}),"\n",(0,s.jsx)(t.h4,{id:"init_form_fields",children:"init_form_fields()"}),"\n",(0,s.jsxs)(t.p,{children:["Use this method to set ",(0,s.jsx)(t.code,{children:"$this->form_fields"})," - these are options you'll show in admin on your gateway settings page and make use of the ",(0,s.jsx)(t.a,{href:"https://developer.woocommerce.com/docs/settings-api/",children:"WC Settings API"}),"."]}),"\n",(0,s.jsxs)(t.p,{children:["A basic set of settings for your gateway would consist of ",(0,s.jsx)(t.em,{children:"enabled"}),", ",(0,s.jsx)(t.em,{children:"title"})," and ",(0,s.jsx)(t.em,{children:"description"}),":"]}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{className:"language-php",children:"$this->form_fields = array(\n'enabled' => array(\n'title' => \\_\\_( 'Enable/Disable', 'woocommerce' ),\n'type' => 'checkbox',\n'label' => \\_\\_( 'Enable Cheque Payment', 'woocommerce' ),\n'default' => 'yes'\n),\n'title' => array(\n'title' => \\_\\_( 'Title', 'woocommerce' ),\n'type' => 'text',\n'description' => \\_\\_( 'This controls the title which the user sees during checkout.', 'woocommerce' ),\n'default' => \\_\\_( 'Cheque Payment', 'woocommerce' ),\n'desc_tip' => true,\n),\n'description' => array(\n'title' => \\_\\_( 'Customer Message', 'woocommerce' ),\n'type' => 'textarea',\n'default' => ''\n)\n);\n"})}),"\n",(0,s.jsx)(t.h4,{id:"process_payment-order_id-",children:"process_payment( $order_id )"}),"\n",(0,s.jsx)(t.p,{children:"Now for the most important part of the gateway - handling payment and processing the order. Process_payment also tells WC where to redirect the user, and this is done with a returned array."}),"\n",(0,s.jsx)(t.p,{children:"Here is an example of a process_payment function from the Cheque gateway:"}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{className:"language-php",children:"function process_payment( $order_id ) {\nglobal $woocommerce;\n$order = new WC_Order( $order_id );\n\n    // Mark as on-hold (we're awaiting the cheque)\n    $order->update\\_status('on-hold', \\_\\_( 'Awaiting cheque payment', 'woocommerce' ));\n\n    // Remove cart\n    $woocommerce->cart->empty\\_cart();\n\n    // Return thankyou redirect\n    return array(\n        'result' => 'success',\n        'redirect' => $this->get\\_return\\_url( $order )\n    );\n\n}\n"})}),"\n",(0,s.jsx)(t.p,{children:"As you can see, its job is to:"}),"\n",(0,s.jsxs)(t.ul,{children:["\n",(0,s.jsx)(t.li,{children:"Get and update the order being processed"}),"\n",(0,s.jsx)(t.li,{children:"Return success and redirect URL (in this case the thanks page)"}),"\n"]}),"\n",(0,s.jsx)(t.p,{children:"Cheque gives the order On-Hold status since the payment cannot be verified automatically. If, however, you are building a direct gateway, then you can complete the order here instead. Rather than using update_status when an order is paid, you should use payment_complete:"}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{className:"language-php",children:"$order->payment_complete();\n"})}),"\n",(0,s.jsx)(t.p,{children:"This ensures stock reductions are made, and the status is changed to the correct value."}),"\n",(0,s.jsx)(t.p,{children:"If payment fails, you should throw an error and return an array with the failure status:"}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{className:"language-php",children:"wc_add_notice( __('Payment error:', 'woothemes') . $error_message, 'error' );\nreturn array(\n    'result'   => 'failure'\n);\n"})}),"\n",(0,s.jsx)(t.p,{children:"WooCommerce will catch this error and show it on the checkout page."}),"\n",(0,s.jsxs)(t.p,{children:["Stock levels are updated via actions (",(0,s.jsx)(t.code,{children:"woocommerce_payment_complete"})," and in transitions between order statuses), so it's no longer needed to manually call the methods reducing stock levels while processing the payment."]}),"\n",(0,s.jsx)(t.h3,{id:"updating-order-status-and-adding-notes",children:"Updating Order Status and Adding Notes"}),"\n",(0,s.jsx)(t.p,{children:"Updating the order status can be done using functions in the order class. You should only do this if the order status is not processing (in which case you should use payment_complete()). An example of updating to a custom status would be:"}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{className:"language-php",children:"$order = new WC\\_Order( $order\\_id );\n$order->update_status('on-hold', \\_\\_('Awaiting cheque payment', 'woothemes'));\n"})}),"\n",(0,s.jsx)(t.p,{children:"The above example updates the status to On-Hold and adds a note informing the owner that it is awaiting a Cheque. You can add notes without updating the order status; this is used for adding a debug message:"}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{className:"language-php",children:"$order->add_order_note( \\_\\_('IPN payment completed', 'woothemes') );\n"})}),"\n",(0,s.jsx)(t.h3,{id:"order-status-best-practice",children:"Order Status Best Practice"}),"\n",(0,s.jsxs)(t.ul,{children:["\n",(0,s.jsxs)(t.li,{children:["If the order has completed but the admin needs to manually verify payment, use ",(0,s.jsx)(t.strong,{children:"On-Hold"})]}),"\n",(0,s.jsxs)(t.li,{children:["If the order fails and has already been created, set to ",(0,s.jsx)(t.strong,{children:"Failed"})]}),"\n",(0,s.jsxs)(t.li,{children:["If payment is complete, let WooCommerce handle the status and use ",(0,s.jsx)(t.code,{children:"$order->payment_complete()"}),". WooCommerce will use either ",(0,s.jsx)(t.strong,{children:"Completed"})," or ",(0,s.jsx)(t.strong,{children:"Processing"})," status and handle stock."]}),"\n"]}),"\n",(0,s.jsx)(t.h2,{id:"notes-on-direct-gateways",children:"Notes on Direct Gateways"}),"\n",(0,s.jsx)(t.p,{children:"If you are creating an advanced, direct gateway (i.e., one that takes payment on the actual checkout page), there are additional steps involved. First, you need to set has_fields to true in the gateway constructor:"}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{className:"language-php",children:"$this->has_fields = true;\n"})}),"\n",(0,s.jsx)(t.p,{children:"This tells the checkout to output a 'payment_box' containing your direct payment form that you define next."}),"\n",(0,s.jsxs)(t.p,{children:["Create a method called ",(0,s.jsx)(t.code,{children:"payment_fields()"})," - this contains your form, most likely to have credit card details."]}),"\n",(0,s.jsxs)(t.p,{children:["The next but optional method to add is ",(0,s.jsx)(t.code,{children:"validate_fields()"}),". Return true if the form passes validation or false if it fails. You can use the ",(0,s.jsx)(t.code,{children:"wc_add_notice()"})," function if you want to add an error and display it to the user."]}),"\n",(0,s.jsxs)(t.p,{children:["Finally, you need to add payment code inside your ",(0,s.jsx)(t.code,{children:"process_payment( $order_id )"})," method. This takes the posted form data and attempts payment directly via the payment provider."]}),"\n",(0,s.jsx)(t.p,{children:"If payment fails, you should output an error and return the failure array:"}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{className:"language-php",children:"wc_add_notice( \\_\\_('Payment error:', 'woothemes') . $error_message, 'error' );\nreturn array(\n    'result'   => 'failure',\n);\n"})}),"\n",(0,s.jsx)(t.p,{children:"If payment is successful, you should set the order as paid and return the success array:"}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{className:"language-php",children:"// Payment complete\n$order->payment_complete();\n"})}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{className:"language-php",children:"// Return thank you page redirect\nreturn array(\n'result' => 'success',\n'redirect' => $this->get_return_url( $order )\n);\n"})}),"\n",(0,s.jsx)(t.h2,{id:"working-with-payment-gateway-callbacks-such-as-paypal-ipn",children:"Working with Payment Gateway Callbacks (such as PayPal IPN)"}),"\n",(0,s.jsx)(t.p,{children:"If you are building a gateway that makes a callback to your store to tell you about the status of an order, you need to add code to handle this inside your gateway."}),"\n",(0,s.jsx)(t.p,{children:"The best way to add a callback and callback handler is to use WC-API hooks. An example would be as PayPal Standard does. It sets the callback/IPN URL as:"}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{className:"language-php",children:"str_replace( 'https:', 'http:', add_query_arg( 'wc-api', 'WC_Gateway_Paypal', home_url( '/' ) ) );\n"})}),"\n",(0,s.jsx)(t.p,{children:"Then hooks in its handler to the hook:"}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{className:"language-php",children:"add_action( 'woocommerce_api_wc_gateway_paypal', array( $this, 'check_ipn_response' ) );\n"})}),"\n",(0,s.jsx)(t.p,{children:"WooCommerce will call your gateway and run the action when the URL is called."}),"\n",(0,s.jsxs)(t.p,{children:["For more information, see ",(0,s.jsx)(t.a,{href:"https://woocommerce.com/document/wc_api-the-woocommerce-api-callback/",children:"WC_API - The WooCommerce API Callback"}),"."]}),"\n",(0,s.jsx)(t.h2,{id:"hooks-in-gateways",children:"Hooks in Gateways"}),"\n",(0,s.jsx)(t.p,{children:"It's important to note that adding hooks inside gateway classes may not trigger. Gateways are only loaded when needed, such as during checkout and on the settings page in admin."}),"\n",(0,s.jsx)(t.p,{children:"You should keep hooks outside of the class or use WC-API if you need to hook into WordPress events from your class."})]})}function h(e={}){const{wrapper:t}={...(0,o.R)(),...e.components};return t?(0,s.jsx)(t,{...e,children:(0,s.jsx)(l,{...e})}):l(e)}},8453:(e,t,a)=>{a.d(t,{R:()=>r,x:()=>i});var n=a(6540);const s={},o=n.createContext(s);function r(e){const t=n.useContext(o);return n.useMemo((function(){return"function"==typeof e?e(t):{...t,...e}}),[t,e])}function i(e){let t;return t=e.disableParentContext?"function"==typeof e.components?e.components(s):e.components||s:r(e.components),n.createElement(o.Provider,{value:t},e.children)}}}]);