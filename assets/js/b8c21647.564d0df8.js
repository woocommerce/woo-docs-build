"use strict";(self.webpackChunkwoo_docs_migration=self.webpackChunkwoo_docs_migration||[]).push([[6724],{4612:(t,e,n)=>{n.r(e),n.d(e,{assets:()=>c,contentTitle:()=>r,default:()=>p,frontMatter:()=>o,metadata:()=>s,toc:()=>h});const s=JSON.parse('{"id":"features/shipping/shipping-method-api","title":"Shipping method API","description":"WooCommerce has a Shipping Method API which plugins can use to add their own rates. This article will take you through the steps to creating a new shipping method based on the core Flat Rate method that interacts with the Shipping API.","source":"@site/../features/shipping/shipping-method-api.md","sourceDirName":"features/shipping","slug":"/features/shipping/shipping-method-api","permalink":"/docs/features/shipping/shipping-method-api","draft":false,"unlisted":false,"editUrl":"https://github.com/woocommerce/woocommerce/tree/docusaurus-docs-prep/docs/docs/../features/shipping/shipping-method-api.md","tags":[],"version":"current","frontMatter":{"post_title":"Shipping method API","sidebar_label":"Shipping method API"},"sidebar":"docsSidebar","previous":{"title":"Payment Token API","permalink":"/docs/features/payments/payment-token-api"},"next":{"title":"Add columns to analytics reports","permalink":"/docs/features/analytics/adding-columns-to-analytics-reports-and-csv-downloads"}}');var i=n(4848),a=n(8453);const o={post_title:"Shipping method API",sidebar_label:"Shipping method API"},r="Shipping method API",c={},h=[{value:"Create a plugin",id:"create-a-plugin",level:2},{value:"Checking for WooCommerce and creating a function to house your class",id:"checking-for-woocommerce-and-creating-a-function-to-house-your-class",level:2},{value:"Create your class",id:"create-your-class",level:2},{value:"Defining settings/options",id:"defining-settingsoptions",level:2},{value:"Sanitizing the cost",id:"sanitizing-the-cost",level:2},{value:"Adding a rate",id:"adding-a-rate",level:2},{value:"The calculate_shipping() method",id:"the-calculate_shipping-method",level:2},{value:"Piecing it all together",id:"piecing-it-all-together",level:2}];function l(t){const e={a:"a",code:"code",h1:"h1",h2:"h2",header:"header",p:"p",pre:"pre",...(0,a.R)(),...t.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(e.header,{children:(0,i.jsx)(e.h1,{id:"shipping-method-api",children:"Shipping method API"})}),"\n",(0,i.jsx)(e.p,{children:"WooCommerce has a Shipping Method API which plugins can use to add their own rates. This article will take you through the steps to creating a new shipping method based on the core Flat Rate method that interacts with the Shipping API."}),"\n",(0,i.jsx)(e.h2,{id:"create-a-plugin",children:"Create a plugin"}),"\n",(0,i.jsxs)(e.p,{children:["First off, create a regular WordPress/WooCommerce plugin - see our ",(0,i.jsx)(e.a,{href:"/docs/extensions/getting-started-extensions/building-your-first-extension",children:"Building Your First Extension guide"})," to get started. You'll define your shipping method class in this plugin file and maintain it outside of WooCommerce."]}),"\n",(0,i.jsx)(e.h2,{id:"checking-for-woocommerce-and-creating-a-function-to-house-your-class",children:"Checking for WooCommerce and creating a function to house your class"}),"\n",(0,i.jsx)(e.p,{children:"Before we attempt to load our class, we need to make sure that WooCommerce is active and the primary classes and functions necessary for us to work are available. Once we know those are available, we can add an action to initialize our class, and a filter to add our method to the primary shipping method list."}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{className:"language-php",children:"/**\n * If WooCommerce is active, then these classes and function will exist.\n */\nif ( class_exists( 'woocommerce' ) && class_exists( 'WC_Shipping_Method' ) && function_exists( 'WC' ) ) {\n\t// We add an action to init our shipping method class, and a filter to add our shipping method to the method list.\n\tadd_action( 'woocommerce_shipping_init', 'your_shipping_method_init' );\n\tadd_filter( 'woocommerce_shipping_methods', 'your_shipping_method_add' );\n}\n\n/**\n * Your function to add your shipping method to the shipping method list.\n */\nfunction your_shipping_method_add( $methods ) {\n\t$methods['your_shipping_method'] = 'WC_Your_Shipping_Method';\n\treturn $methods;\n}\n\n/**\n * Your function to init your shipping method class.\n */\nfunction your_shipping_method_init() {\n    // Your class will go here\n}\n"})}),"\n",(0,i.jsx)(e.h2,{id:"create-your-class",children:"Create your class"}),"\n",(0,i.jsx)(e.p,{children:"Now we create your class to place inside the function just created. It is best to make sure the class doesn't already exist to make sure there are no unexpected fatal errors. The class will need to extend the shipping method class so that we have access to the Shipping and Settings APIs. We also make sure to declare neccessary properties and then define more options/properties in the constructor, and we end with a call to the init method."}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{className:"language-php",children:"if ( ! class_exists( 'WC_Your_Shipping_Method' ) ) {\n\tclass WC_Your_Shipping_Method extends WC_Shipping_Method {\n\t\t/**\n\t\t * Shipping method cost.\n\t\t *\n\t\t * @var string\n\t\t */\n\t\tpublic $cost;\n\n\t\t/**\n\t\t * Shipping method type.\n\t\t *\n\t\t * @var string\n\t\t */\n\t\tpublic $type;\n\n\t\t/**\n\t\t * Constructor for your shipping class.\n\t\t *\n\t\t * @param  int  $instance_id Shipping method instance ID. A new instance ID is assigned per instance created in a shipping zone.\n\t\t * @return void\n\t\t */\n\t\tpublic function __construct( $instance_id = 0 ) {\n\t\t\t$this->id                 = 'your_shipping_method'; // ID for your shipping method. Should be unique.\n\t\t\t$this->instance_id        = absint( $instance_id );\n\t\t\t$this->method_title       = __( 'Your Shipping Method', 'your_text_domain' );  // Title shown in admin.\n\t\t\t$this->method_description = __( 'Description of your shipping method', 'your_text_domain' ); // Description shown in admin.\n\t\t\t$this->supports           = array(\n\t\t\t\t'settings',                // Provides a stand alone settings tab for your shipping method under WooCommerce > Settings > Shipping.\n\t\t\t\t'shipping-zones',          // Allows merchants to add your shipping method to shipping zones.\n\t\t\t\t'instance-settings',       // Allows for a page where merchants can edit the instance of your method included in a shipping zone.\n\t\t\t\t'instance-settings-modal', // Allows for a modal where merchants can edit the instance of your method included in a shipping zone.\n\t\t\t);\n\n\t\t\t// Additional initialization of the shipping method.\n\t\t\t$this->init();\n\t\t}\n\t}\n}\n"})}),"\n",(0,i.jsx)(e.h2,{id:"defining-settingsoptions",children:"Defining settings/options"}),"\n",(0,i.jsxs)(e.p,{children:["We want to make sure to add an action for the shipping method when options are updated to call ",(0,i.jsx)(e.code,{children:"process_admin_options"}),", this will save any settings entered by a merchant/admin when they choose to save."]}),"\n",(0,i.jsxs)(e.p,{children:["Options are then able to be defined using the ",(0,i.jsx)(e.a,{href:"https://developer.woocommerce.com/docs/settings-api/",children:"WooCommerce settings API"}),". We have two additional methods ",(0,i.jsx)(e.code,{children:"init_form_fields"})," and ",(0,i.jsx)(e.code,{children:"init_instance_form_fields"})," that will initialize the form fields for both the stand alone settings and instance settings for us. Additional options, such as the title, tax status, etc, are set via the ",(0,i.jsx)(e.code,{children:"get_option"})," method of the Settings API. These are set for either the stand alone page, or the instance settings, whichever is being displayed."]}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{className:"language-php",children:"\t/**\n\t * Additional initialization of options for the shipping method not necessary in the constructor.\n\t *\n\t * @return void\n\t */\n\tpublic function init() {\n\t\t// Save settings in admin if any have been defined. (using Shipping/Settings API)\n\t\tadd_action( 'woocommerce_update_options_shipping_' . $this->id, array( $this, 'process_admin_options' ) );\n\n\t\t// Init stand alone settings and also the instance settings form fields.\n\t\t$this->init_form_fields();\n\t\t$this->init_instance_form_fields();\n\n\t\t// Use the Settings API to get the saved options to use for the settings fields.\n\t\t$this->title      = $this->get_option( 'title' );\n\t\t$this->tax_status = $this->get_option( 'tax_status' );\n\t\t$this->cost       = $this->get_option( 'cost' );\n\t\t$this->type       = $this->get_option( 'type', 'class' );\n\t}\n\n\t/**\n\t * Our method to initialize our form fields for our stand alone settings page, if needed.\n\t *\n\t * @return void\n\t */\n\tpublic function init_form_fields() {\n\t\t// Set the form_fields property to an array that will be able to be used by the Settings API to show the fields on the page.\n\t\t$this->form_fields = array(\n\t\t\t'title'      => array(\n\t\t\t\t'title'       => __( 'Name', 'your_text_domain' ),\n\t\t\t\t'type'        => 'text',\n\t\t\t\t'description' => __( 'Your customers will see the name of this shipping method during checkout.', 'your_text_domain' ),\n\t\t\t\t'default'     => __( 'Your shipping method', 'your_text_domain' ),\n\t\t\t\t'placeholder' => __( 'e.g. Standard national', 'your_text_domain' ),\n\t\t\t\t'desc_tip'    => true, // Include this if you would like your description to show as a tooltip.\n\t\t\t),\n\t\t\t'tax_status' => array(\n\t\t\t\t'title'   => __( 'Tax status', 'your_text_domain' ),\n\t\t\t\t'type'    => 'select',\n\t\t\t\t'class'   => 'wc-enhanced-select',\n\t\t\t\t'default' => 'taxable',\n\t\t\t\t'options' => array(\n\t\t\t\t\t'taxable' => __( 'Taxable', 'your_text_domain' ),\n\t\t\t\t\t'none'    => _x( 'None', 'Tax status', 'your_text_domain' ),\n\t\t\t\t),\n\t\t\t),\n\t\t\t'cost'       => array(\n\t\t\t\t'title'             => __( 'Cost', 'your_text_domain' ),\n\t\t\t\t'type'              => 'text',\n\t\t\t\t'placeholder'       => '',\n\t\t\t\t'description'       => __( 'Enter a cost (excl. tax).', 'your_text_domain' ),\n\t\t\t\t'default'           => '0',\n\t\t\t\t'desc_tip'          => true,\n\t\t\t\t'sanitize_callback' => array( $this, 'sanitize_cost' ),\n\t\t\t),\n\t\t);\n\t}\n\n\t/**\n\t * Our method to initialize our form fields for separate instances.\n\t *\n\t * @return void\n\t */\n\tprivate function init_instance_form_fields() {\n\t\t// Define some strings that will be used several times for the cost decription and link.\n\t\t$cost_desc = __( 'Enter a cost (excl. tax).', 'your_text_domain' );\n\t\t$cost_link = sprintf( '<span id=\"wc-shipping-advanced-costs-help-text\">%s <a target=\"_blank\" href=\"https://woocommerce.com/document/flat-rate-shipping/#advanced-costs\">%s</a>.</span>', __( 'Charge a flat rate per item, or enter a cost formula to charge a percentage based cost or a minimum fee. Learn more about', 'your_text_domain' ), __( 'advanced costs', 'your_text_domain' ) );\n\n\t\t// Start the array of fields.\n\t\t$fields = array(\n\t\t\t'title'      => array(\n\t\t\t\t'title'       => __( 'Name', 'your_text_domain' ),\n\t\t\t\t'type'        => 'text',\n\t\t\t\t'description' => __( 'Your customers will see the name of this shipping method during checkout.', 'your_text_domain' ),\n\t\t\t\t'default'     => __( 'Your shipping method', 'your_text_domain' ),\n\t\t\t\t'placeholder' => __( 'e.g. Standard national', 'your_text_domain' ),\n\t\t\t\t'desc_tip'    => true,\n\t\t\t),\n\t\t\t'tax_status' => array(\n\t\t\t\t'title'   => __( 'Tax status', 'your_text_domain' ),\n\t\t\t\t'type'    => 'select',\n\t\t\t\t'class'   => 'wc-enhanced-select',\n\t\t\t\t'default' => 'taxable',\n\t\t\t\t'options' => array(\n\t\t\t\t\t'taxable' => __( 'Taxable', 'your_text_domain' ),\n\t\t\t\t\t'none'    => _x( 'None', 'Tax status', 'your_text_domain' ),\n\t\t\t\t),\n\t\t\t),\n\t\t\t'cost'       => array(\n\t\t\t\t'title'             => __( 'Cost', 'your_text_domain' ),\n\t\t\t\t'type'              => 'text',\n\t\t\t\t'class'             => 'wc-shipping-modal-price',\n\t\t\t\t'placeholder'       => '',\n\t\t\t\t'description'       => $cost_desc,\n\t\t\t\t'default'           => '0',\n\t\t\t\t'desc_tip'          => true,\n\t\t\t\t'sanitize_callback' => array( $this, 'sanitize_cost' ),\n\t\t\t),\n\t\t);\n\n\t\t/**\n\t\t * Flat rate shipping has the ability to add rates per shipping class, so here we get the shipping classes and then provide fields\n\t\t * for merchants/admins to use to be able to specify these costs. \n\t\t */\n\t\t$shipping_classes = WC()->shipping()->get_shipping_classes();\n\n\t\tif ( ! empty( $shipping_classes ) ) {\n\t\t\t$fields['class_costs'] = array(\n\t\t\t\t'title'       => __( 'Shipping class costs', 'your_text_domain' ),\n\t\t\t\t'type'        => 'title',\n\t\t\t\t'default'     => '',\n\t\t\t\t/* translators: %s: URL for link */\n\t\t\t\t'description' => sprintf( __( 'These costs can optionally be added based on the <a target=\"_blank\" href=\"%s\">product shipping class</a>. Learn more about <a target=\"_blank\" href=\"https://woocommerce.com/document/flat-rate-shipping/#shipping-classes\">setting shipping class costs</a>.', 'your_text_domain' ), admin_url( 'admin.php?page=wc-settings&tab=shipping&section=classes' ) ),\n\t\t\t);\n\t\t\tforeach ( $shipping_classes as $shipping_class ) {\n\t\t\t\tif ( ! isset( $shipping_class->term_id ) ) {\n\t\t\t\t\tcontinue;\n\t\t\t\t}\n\t\t\t\t$fields[ 'class_cost_' . $shipping_class->term_id ] = array(\n\t\t\t\t\t/* translators: %s: shipping class name */\n\t\t\t\t\t'title'             => sprintf( __( '\"%s\" shipping class cost', 'your_text_domain' ), esc_html( $shipping_class->name ) ),\n\t\t\t\t\t'type'              => 'text',\n\t\t\t\t\t'class'             => 'wc-shipping-modal-price',\n\t\t\t\t\t'placeholder'       => __( 'N/A', 'your_text_domain' ),\n\t\t\t\t\t'description'       => $cost_desc,\n\t\t\t\t\t'default'           => $this->get_option( 'class_cost_' . $shipping_class->slug ),\n\t\t\t\t\t'desc_tip'          => true,\n\t\t\t\t\t'sanitize_callback' => array( $this, 'sanitize_cost' ),\n\t\t\t\t);\n\t\t\t}\n\n\t\t\t$fields['no_class_cost'] = array(\n\t\t\t\t'title'             => __( 'No shipping class cost', 'your_text_domain' ),\n\t\t\t\t'type'              => 'text',\n\t\t\t\t'class'             => 'wc-shipping-modal-price',\n\t\t\t\t'placeholder'       => __( 'N/A', 'your_text_domain' ),\n\t\t\t\t'description'       => $cost_desc,\n\t\t\t\t'default'           => '',\n\t\t\t\t'desc_tip'          => true,\n\t\t\t\t'sanitize_callback' => array( $this, 'sanitize_cost' ),\n\t\t\t);\n\n\t\t\t$fields['type'] = array(\n\t\t\t\t'title'       => __( 'Calculation type', 'your_text_domain' ),\n\t\t\t\t'type'        => 'select',\n\t\t\t\t'class'       => 'wc-enhanced-select',\n\t\t\t\t'default'     => 'class',\n\t\t\t\t'options'     => array(\n\t\t\t\t\t'class' => __( 'Per class: Charge shipping for each shipping class individually', 'your_text_domain' ),\n\t\t\t\t\t'order' => __( 'Per order: Charge shipping for the most expensive shipping class', 'your_text_domain' ),\n\t\t\t\t),\n\t\t\t\t'description' => $cost_link,\n\t\t\t);\n\t\t}\n\n\t\t// And finally we set the instance_form_fields property for the Shipping API to use.\n\t\t$this->instance_form_fields = $fields;\n\t}\n"})}),"\n",(0,i.jsx)(e.h2,{id:"sanitizing-the-cost",children:"Sanitizing the cost"}),"\n",(0,i.jsxs)(e.p,{children:["In the previous code snippets you can see that there is a ",(0,i.jsx)(e.code,{children:"sanitize_callback"})," to use ",(0,i.jsx)(e.code,{children:"sanitize_cost"}),", while this may not always be needed, it is still good to keep sanitizing user input in mind. Since a cost field will need to be a text field to allow for a decimal separator, we need to make sure the value entered is valid. For this, we introduce the below method."]}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{className:"language-php",children:"\t/**\n\t * Sanitize the cost value.\n\t * This method is called when the `sanitize_callback` method is called in the Settings API while the values input by the merchant are being saved.\n\t *\n\t * @param string $value Unsanitized value.\n\t * @return string\n\t * @throws Exception If the cost is not numeric.\n\t */\n\tpublic function sanitize_cost( $value ) {\n\t\t// If the value is null, then set it to zero. Run the value through WordPress core sanitization functions, the remove the currency symbol, if present.\n\t\t$value = is_null( $value ) ? '0' : $value;\n\t\t$value = wp_kses_post( trim( wp_unslash( $value ) ) );\n\t\t$value = str_replace( array( get_woocommerce_currency_symbol(), html_entity_decode( get_woocommerce_currency_symbol() ) ), '', $value );\n\n\t\t// Get the current locale and all possible decimal separators.\n\t\t$locale   = localeconv();\n\t\t$decimals = array( wc_get_price_decimal_separator(), $locale['decimal_point'], $locale['mon_decimal_point'], ',' );\n\n\t\t// Remove whitespace, then decimals, and then invalid start/end characters.\n\t\t$value = preg_replace( '/\\s+/', '', $value );\n\t\t$value = str_replace( $decimals, '.', $value );\n\t\t$value = rtrim( ltrim( $value, \"\\t\\n\\r\\0\\x0B+*/\" ), \"\\t\\n\\r\\0\\x0B+-*/\" );\n\n\t\t// If the value is not numeric, then throw an exception.\n\t\tif ( ! is_numeric( $value ) ) {\n\t\t\tthrow new Exception( 'Invalid cost entered.' );\n\t\t}\n\t\treturn $value;\n\t}\n"})}),"\n",(0,i.jsx)(e.h2,{id:"adding-a-rate",children:"Adding a rate"}),"\n",(0,i.jsxs)(e.p,{children:["Rates are added via the Shipping API using the ",(0,i.jsx)(e.code,{children:"add_rate"})," method. Below is a breakdown of available options, and in the next section we will put this to use."]}),"\n",(0,i.jsx)(e.p,{children:"Your shipping method can pass as many rates as needed, just ensure that the id for each is different. The user will get to choose rate during checkout."}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{className:"language-php",children:"$rate = array(\n    'label' => '',   // Label for the rate.\n    'cost'  => '0',  // Amount for shipping or an array of costs (for per item shipping).\n    'taxes' => '',   // Pass an array of taxes, or pass nothing to have it calculated for you, or pass 'false' to calculate no tax for this method.\n    'calc_tax' => 'per_order' // Calc tax per_order or per_item. Per item needs an array of costs passed via 'cost'.\n);\n\n// Register the rate\n$this->add_rate( $rate );\n"})}),"\n",(0,i.jsx)(e.h2,{id:"the-calculate_shipping-method",children:"The calculate_shipping() method"}),"\n",(0,i.jsxs)(e.p,{children:["The method to use to add your rates is ",(0,i.jsx)(e.code,{children:"calculate_shipping"}),", WooCommerce will call this when doing shipping calculations in the cart and checkout. Do your plugin specific calculations here and then add the rates via the Shipping API."]}),"\n",(0,i.jsxs)(e.p,{children:["Here we also include the ",(0,i.jsx)(e.code,{children:"find_shipping_classes"})," method, which gets the shipping classes from each item in the package."]}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{className:"language-php",children:"\t/**\n\t* Calculate the shipping costs.\n\t*\n\t* @param array $package Package of items from cart.\n\t*/\n\tpublic function calculate_shipping( $package = array() ) {\n\t\t// Get the rate set for this instance.\n\t\t$rate = array(\n\t\t\t'id'      => $this->get_rate_id(), // Get the instance rate ID from the Shipping API.\n\t\t\t'label'   => $this->title,\n\t\t\t'cost'    => 0,\n\t\t\t'package' => $package,\n\t\t);\n\n\t\t// Calculate the costs.\n\t\t$has_costs = false; // True when a cost is set. False if all costs are blank strings.\n\t\t$cost      = $this->get_option( 'cost' );\n\n\t\t// If a cost has been set, then we evaluate the cost to make sure it is valid.\n\t\tif ( '' !== $cost ) {\n\t\t\t$has_costs    = true;\n\t\t\t$rate['cost'] = $cost;\n\t\t}\n\n\t\t// Flat rate shipping has the ability to set a cost per shipping class, so here we get the shipping classes and add those costs, as well.\n\t\t$shipping_classes = WC()->shipping()->get_shipping_classes();\n\t\tif ( ! empty( $shipping_classes ) ) {\n\t\t\t// Check to see if there are shipping classes assigned to the products in the package/cart.\n\t\t\t$found_shipping_classes = $this->find_shipping_classes( $package );\n\t\t\t$highest_class_cost     = 0;\n\n\t\t\t// If shipping classes are found to be assigned to the products, then we go through each shipping class.\n\t\t\tforeach ( $found_shipping_classes as $shipping_class => $products ) {\n\t\t\t\t// Also handles backwards compatibility when slugs were used instead of ids.\n\t\t\t\t$shipping_class_term = get_term_by( 'slug', $shipping_class, 'product_shipping_class' );\n\t\t\t\t$class_cost   = $shipping_class_term && $shipping_class_term->term_id ? $this->get_option( 'class_cost_' . $shipping_class_term->term_id, $this->get_option( 'class_cost_' . $shipping_class, '' ) ) : $this->get_option( 'no_class_cost', '' );\n\n\t\t\t\t// If a cost is not assigned to the shipping class, then we move to the next class.\n\t\t\t\tif ( '' === $class_cost ) {\n\t\t\t\t\tcontinue;\n\t\t\t\t}\n\n\t\t\t\t// We have a shipping class cost, so we evaluate the class cost to confirm it is valid.\n\t\t\t\t$has_costs = true;\n\n\t\t\t\t/**\n\t\t\t\t* Flat rate has two options when it comes to shipping class, per class or per order.\n\t\t\t\t* Here we check that setting so we can apply the costs accordingly.\n\t\t\t\t*/\n\t\t\t\tif ( 'class' === $this->type ) {\n\t\t\t\t\t$rate['cost'] += $class_cost;\n\t\t\t\t} else {\n\t\t\t\t\t$highest_class_cost = $class_cost > $highest_class_cost ? $class_cost : $highest_class_cost;\n\t\t\t\t}\n\t\t\t}\n\n\t\t\t// If the cost is per order, then we apply the highest class cost to the base cost.\n\t\t\tif ( 'order' === $this->type && $highest_class_cost ) {\n\t\t\t\t$rate['cost'] += $highest_class_cost;\n\t\t\t}\n\t\t}\n\n\t\tif ( $has_costs ) {\n\t\t\t$this->add_rate( $rate );\n\t\t}\n\n\t\t/**\n\t\t* Developers can add additional flat rates based on this one via this action since @version 2.4.\n\t\t*\n\t\t* Previously there were (overly complex) options to add additional rates however this was not user.\n\t\t* friendly and goes against what Flat Rate Shipping was originally intended for.\n\t\t*/\n\t\tdo_action( 'woocommerce_' . $this->id . '_shipping_add_rate', $this, $rate );\n\t}\n\n\t/**\n\t* Finds and returns shipping classes and the products with said class.\n\t*\n\t* @param mixed $package Package of items from cart.\n\t* @return array\n\t*/\n\tpublic function find_shipping_classes( $package ) {\n\t\t$found_shipping_classes = array();\n\n\t\tforeach ( $package['contents'] as $item_id => $values ) {\n\t\t\tif ( $values['data']->needs_shipping() ) {\n\t\t\t\t$found_class = $values['data']->get_shipping_class();\n\n\t\t\t\tif ( ! isset( $found_shipping_classes[ $found_class ] ) ) {\n\t\t\t\t\t$found_shipping_classes[ $found_class ] = array();\n\t\t\t\t}\n\n\t\t\t\t$found_shipping_classes[ $found_class ][ $item_id ] = $values;\n\t\t\t}\n\t\t}\n\n\t\treturn $found_shipping_classes;\n\t}\n"})}),"\n",(0,i.jsx)(e.h2,{id:"piecing-it-all-together",children:"Piecing it all together"}),"\n",(0,i.jsx)(e.p,{children:"Our trimmed down version of the Flat Rate shipping method as a stand alone plugin looks like this:"}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{className:"language-php",children:"<?php\n/**\n * Plugin Name: Your Shipping plugin\n * Plugin URI: https://woocommerce.com/\n * Description: Your shipping method plugin\n * Version: 1.0.0\n * Author: WooCommerce\n * Author URI: https://woocommerce.com/\n * Text Domain: your_text_domain\n */\n\n/**\n * If WooCommerce is active, then the class will exist.\n */\nif ( class_exists( 'woocommerce' ) && class_exists( 'WC_Shipping_Method' ) && function_exists( 'WC' ) ) {\n\t// We add an action to init our shipping method class, and a filter to add our shipping method to the method list.\n\tadd_action( 'woocommerce_shipping_init', 'your_shipping_method_init' );\n\tadd_filter( 'woocommerce_shipping_methods', 'your_shipping_method_add' );\n}\n\n/**\n * Your function to add your shipping method to the shipping method list.\n */\nfunction your_shipping_method_add( $methods ) {\n\t$methods['your_shipping_method'] = 'WC_Your_Shipping_Method';\n\treturn $methods;\n}\n\n/**\n * Your function to init your shipping method class.\n */\nfunction your_shipping_method_init() {\n\t/**\n\t * Ideally this would include the class from another file, but for demonstration purposes we will include it here.\n\t */\n\tif ( ! class_exists( 'WC_Your_Shipping_Method' ) ) {\n\t\tclass WC_Your_Shipping_Method extends WC_Shipping_Method {\n\t\t\t/**\n\t\t\t * Shipping method cost.\n\t\t\t *\n\t\t\t * @var string\n\t\t\t */\n\t\t\tpublic $cost;\n\n\t\t\t/**\n\t\t\t * Shipping method type.\n\t\t\t *\n\t\t\t * @var string\n\t\t\t */\n\t\t\tpublic $type;\n\n\t\t\t/**\n\t\t\t * Constructor for your shipping class.\n\t\t\t *\n\t\t\t * @param  int  $instance_id Shipping method instance ID. A new instance ID is assigned per instance created in a shipping zone.\n\t\t\t * @return void\n\t\t\t */\n\t\t\tpublic function __construct( $instance_id = 0 ) {\n\t\t\t\t$this->id                 = 'your_shipping_method'; // ID for your shipping method. Should be unique.\n\t\t\t\t$this->instance_id        = absint( $instance_id );\n\t\t\t\t$this->method_title       = __( 'Your Shipping Method', 'your_text_domain' );  // Title shown in admin.\n\t\t\t\t$this->method_description = __( 'Description of your shipping method', 'your_text_domain' ); // Description shown in admin.\n\t\t\t\t$this->supports           = array(\n\t\t\t\t\t'settings',                // Provides a stand alone settings tab for your shipping method under WooCommerce > Settings > Shipping.\n\t\t\t\t\t'shipping-zones',          // Allows merchants to add your shipping method to shipping zones.\n\t\t\t\t\t'instance-settings',       // Allows for a page where merchants can edit the instance of your method included in a shipping zone.\n\t\t\t\t\t'instance-settings-modal', // Allows for a modal where merchants can edit the instance of your method included in a shipping zone.\n\t\t\t\t);\n\n\t\t\t\t// Additional initialization of the shipping method.\n\t\t\t\t$this->init();\n\t\t\t}\n\n\t\t\t/**\n\t\t\t * Additional initialization of options for the shipping method not necessary in the constructor.\n\t\t\t *\n\t\t\t * @return void\n\t\t\t */\n\t\t\tpublic function init() {\n\t\t\t\t// Save settings in admin if any have been defined. (using Shipping/Settings API)\n\t\t\t\tadd_action( 'woocommerce_update_options_shipping_' . $this->id, array( $this, 'process_admin_options' ) );\n\n\t\t\t\t// Init stand alone settings and also the instance settings form fields.\n\t\t\t\t$this->init_form_fields();\n\t\t\t\t$this->init_instance_form_fields();\n\n\t\t\t\t// Use the Settings API to get the saved options to use for the settings fields.\n\t\t\t\t$this->title      = $this->get_option( 'title' );\n\t\t\t\t$this->tax_status = $this->get_option( 'tax_status' );\n\t\t\t\t$this->cost       = $this->get_option( 'cost' );\n\t\t\t\t$this->type       = $this->get_option( 'type', 'class' );\n\t\t\t}\n\n\t\t\t/**\n\t\t\t * Calculate the shipping costs.\n\t\t\t *\n\t\t\t * @param array $package Package of items from cart.\n\t\t\t */\n\t\t\tpublic function calculate_shipping( $package = array() ) {\n\t\t\t\t// Get the rate set for this instance.\n\t\t\t\t$rate = array(\n\t\t\t\t\t'id'      => $this->get_rate_id(), // Get the instance rate ID from the Shipping API.\n\t\t\t\t\t'label'   => $this->title,\n\t\t\t\t\t'cost'    => 0,\n\t\t\t\t\t'package' => $package,\n\t\t\t\t);\n\n\t\t\t\t// Calculate the costs.\n\t\t\t\t$has_costs = false; // True when a cost is set. False if all costs are blank strings.\n\t\t\t\t$cost      = $this->get_option( 'cost' );\n\n\t\t\t\t// If a cost has been set, then we evaluate the cost to make sure it is valid.\n\t\t\t\tif ( '' !== $cost ) {\n\t\t\t\t\t$has_costs    = true;\n\t\t\t\t\t$rate['cost'] = $cost;\n\t\t\t\t}\n\n\t\t\t\t// Flat rate shipping has the ability to set a cost per shipping class, so here we get the shipping classes and add those costs, as well.\n\t\t\t\t$shipping_classes = WC()->shipping()->get_shipping_classes();\n\t\t\t\tif ( ! empty( $shipping_classes ) ) {\n\t\t\t\t\t// Check to see if there are shipping classes assigned to the products in the package/cart.\n\t\t\t\t\t$found_shipping_classes = $this->find_shipping_classes( $package );\n\t\t\t\t\t$highest_class_cost     = 0;\n\n\t\t\t\t\t// If shipping classes are found to be assigned to the products, then we go through each shipping class.\n\t\t\t\t\tforeach ( $found_shipping_classes as $shipping_class => $products ) {\n\t\t\t\t\t\t// Also handles backwards compatibility when slugs were used instead of ids.\n\t\t\t\t\t\t$shipping_class_term = get_term_by( 'slug', $shipping_class, 'product_shipping_class' );\n\t\t\t\t\t\t$class_cost   = $shipping_class_term && $shipping_class_term->term_id ? $this->get_option( 'class_cost_' . $shipping_class_term->term_id, $this->get_option( 'class_cost_' . $shipping_class, '' ) ) : $this->get_option( 'no_class_cost', '' );\n\n\t\t\t\t\t\t// If a cost is not assigned to the shipping class, then we move to the next class.\n\t\t\t\t\t\tif ( '' === $class_cost ) {\n\t\t\t\t\t\t\tcontinue;\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\t// We have a shipping class cost, so we evaluate the class cost to confirm it is valid.\n\t\t\t\t\t\t$has_costs = true;\n\n\t\t\t\t\t\t/**\n\t\t\t\t\t\t * Flat rate has two options when it comes to shipping class, per class or per order.\n\t\t\t\t\t\t * Here we check that setting so we can apply the costs accordingly.\n\t\t\t\t\t\t */\n\t\t\t\t\t\tif ( 'class' === $this->type ) {\n\t\t\t\t\t\t\t$rate['cost'] += $class_cost;\n\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\t$highest_class_cost = $class_cost > $highest_class_cost ? $class_cost : $highest_class_cost;\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\n\t\t\t\t\t// If the cost is per order, then we apply the highest class cost to the base cost.\n\t\t\t\t\tif ( 'order' === $this->type && $highest_class_cost ) {\n\t\t\t\t\t\t$rate['cost'] += $highest_class_cost;\n\t\t\t\t\t}\n\t\t\t\t}\n\n\t\t\t\tif ( $has_costs ) {\n\t\t\t\t\t$this->add_rate( $rate );\n\t\t\t\t}\n\n\t\t\t\t/**\n\t\t\t\t * Developers can add additional flat rates based on this one via this action since @version 2.4.\n\t\t\t\t *\n\t\t\t\t * Previously there were (overly complex) options to add additional rates however this was not user.\n\t\t\t\t * friendly and goes against what Flat Rate Shipping was originally intended for.\n\t\t\t\t */\n\t\t\t\tdo_action( 'woocommerce_' . $this->id . '_shipping_add_rate', $this, $rate );\n\t\t\t}\n\n\t\t\t/**\n\t\t\t * Finds and returns shipping classes and the products with said class.\n\t\t\t *\n\t\t\t * @param mixed $package Package of items from cart.\n\t\t\t * @return array\n\t\t\t */\n\t\t\tpublic function find_shipping_classes( $package ) {\n\t\t\t\t$found_shipping_classes = array();\n\n\t\t\t\tforeach ( $package['contents'] as $item_id => $values ) {\n\t\t\t\t\tif ( $values['data']->needs_shipping() ) {\n\t\t\t\t\t\t$found_class = $values['data']->get_shipping_class();\n\n\t\t\t\t\t\tif ( ! isset( $found_shipping_classes[ $found_class ] ) ) {\n\t\t\t\t\t\t\t$found_shipping_classes[ $found_class ] = array();\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\t$found_shipping_classes[ $found_class ][ $item_id ] = $values;\n\t\t\t\t\t}\n\t\t\t\t}\n\n\t\t\t\treturn $found_shipping_classes;\n\t\t\t}\n\n\t\t\t/**\n\t\t\t * Sanitize the cost value.\n\t\t\t * This method is called when the `sanitize_callback` method is called in the Settings API while the values input by the merchant are being saved.\n\t\t\t *\n\t\t\t * @param string $value Unsanitized value.\n\t\t\t * @return string\n\t\t\t * @throws Exception If the cost is not numeric.\n\t\t\t */\n\t\t\tpublic function sanitize_cost( $value ) {\n\t\t\t\t// If the value is null, then set it to zero. Run the value through WordPress core sanitization functions, the remove the currency symbol, if present.\n\t\t\t\t$value = is_null( $value ) ? '0' : $value;\n\t\t\t\t$value = wp_kses_post( trim( wp_unslash( $value ) ) );\n\t\t\t\t$value = str_replace( array( get_woocommerce_currency_symbol(), html_entity_decode( get_woocommerce_currency_symbol() ) ), '', $value );\n\n\t\t\t\t// Get the current locale and all possible decimal separators.\n\t\t\t\t$locale   = localeconv();\n\t\t\t\t$decimals = array( wc_get_price_decimal_separator(), $locale['decimal_point'], $locale['mon_decimal_point'], ',' );\n\n\t\t\t\t// Remove whitespace, then decimals, and then invalid start/end characters.\n\t\t\t\t$value = preg_replace( '/\\s+/', '', $value );\n\t\t\t\t$value = str_replace( $decimals, '.', $value );\n\t\t\t\t$value = rtrim( ltrim( $value, \"\\t\\n\\r\\0\\x0B+*/\" ), \"\\t\\n\\r\\0\\x0B+-*/\" );\n\n\t\t\t\t// If the value is not numeric, then throw an exception.\n\t\t\t\tif ( ! is_numeric( $value ) ) {\n\t\t\t\t\tthrow new Exception( 'Invalid cost entered.' );\n\t\t\t\t}\n\t\t\t\treturn $value;\n\t\t\t}\n\n\t\t\t/**\n\t\t\t * Our method to initialize our form fields for our stand alone settings page, if needed.\n\t\t\t *\n\t\t\t * @return void\n\t\t\t */\n\t\t\tpublic function init_form_fields() {\n\t\t\t\t// Set the form_fields property to an array that will be able to be used by the Settings API to show the fields on the page.\n\t\t\t\t$this->form_fields = array(\n\t\t\t\t\t'title'      => array(\n\t\t\t\t\t\t'title'       => __( 'Name', 'your_text_domain' ),\n\t\t\t\t\t\t'type'        => 'text',\n\t\t\t\t\t\t'description' => __( 'Your customers will see the name of this shipping method during checkout.', 'your_text_domain' ),\n\t\t\t\t\t\t'default'     => __( 'Your shipping method', 'your_text_domain' ),\n\t\t\t\t\t\t'placeholder' => __( 'e.g. Standard national', 'your_text_domain' ),\n\t\t\t\t\t\t'desc_tip'    => true, // Include this if you would like your description to show as a tooltip.\n\t\t\t\t\t),\n\t\t\t\t\t'tax_status' => array(\n\t\t\t\t\t\t'title'   => __( 'Tax status', 'your_text_domain' ),\n\t\t\t\t\t\t'type'    => 'select',\n\t\t\t\t\t\t'class'   => 'wc-enhanced-select',\n\t\t\t\t\t\t'default' => 'taxable',\n\t\t\t\t\t\t'options' => array(\n\t\t\t\t\t\t\t'taxable' => __( 'Taxable', 'your_text_domain' ),\n\t\t\t\t\t\t\t'none'    => _x( 'None', 'Tax status', 'your_text_domain' ),\n\t\t\t\t\t\t),\n\t\t\t\t\t),\n\t\t\t\t\t'cost'       => array(\n\t\t\t\t\t\t'title'             => __( 'Cost', 'your_text_domain' ),\n\t\t\t\t\t\t'type'              => 'text',\n\t\t\t\t\t\t'placeholder'       => '',\n\t\t\t\t\t\t'description'       => __( 'Enter a cost (excl. tax).', 'your_text_domain' ),\n\t\t\t\t\t\t'default'           => '0',\n\t\t\t\t\t\t'desc_tip'          => true,\n\t\t\t\t\t\t'sanitize_callback' => array( $this, 'sanitize_cost' ),\n\t\t\t\t\t),\n\t\t\t\t);\n\t\t\t}\n\n\t\t\t/**\n\t\t\t * Our method to initialize our form fields for separate instances.\n\t\t\t *\n\t\t\t * @return void\n\t\t\t */\n\t\t\tprivate function init_instance_form_fields() {\n\t\t\t\t// Define some strings that will be used several times for the cost decription and link.\n\t\t\t\t$cost_desc = __( 'Enter a cost (excl. tax).', 'your_text_domain' );\n\t\t\t\t$cost_link = sprintf( '<span id=\"wc-shipping-advanced-costs-help-text\">%s <a target=\"_blank\" href=\"https://woocommerce.com/document/flat-rate-shipping/#advanced-costs\">%s</a>.</span>', __( 'Charge a flat rate per item, or enter a cost formula to charge a percentage based cost or a minimum fee. Learn more about', 'your_text_domain' ), __( 'advanced costs', 'your_text_domain' ) );\n\n\t\t\t\t// Start the array of fields.\n\t\t\t\t$fields = array(\n\t\t\t\t\t'title'      => array(\n\t\t\t\t\t\t'title'       => __( 'Name', 'your_text_domain' ),\n\t\t\t\t\t\t'type'        => 'text',\n\t\t\t\t\t\t'description' => __( 'Your customers will see the name of this shipping method during checkout.', 'your_text_domain' ),\n\t\t\t\t\t\t'default'     => __( 'Your shipping method', 'your_text_domain' ),\n\t\t\t\t\t\t'placeholder' => __( 'e.g. Standard national', 'your_text_domain' ),\n\t\t\t\t\t\t'desc_tip'    => true,\n\t\t\t\t\t),\n\t\t\t\t\t'tax_status' => array(\n\t\t\t\t\t\t'title'   => __( 'Tax status', 'your_text_domain' ),\n\t\t\t\t\t\t'type'    => 'select',\n\t\t\t\t\t\t'class'   => 'wc-enhanced-select',\n\t\t\t\t\t\t'default' => 'taxable',\n\t\t\t\t\t\t'options' => array(\n\t\t\t\t\t\t\t'taxable' => __( 'Taxable', 'your_text_domain' ),\n\t\t\t\t\t\t\t'none'    => _x( 'None', 'Tax status', 'your_text_domain' ),\n\t\t\t\t\t\t),\n\t\t\t\t\t),\n\t\t\t\t\t'cost'       => array(\n\t\t\t\t\t\t'title'             => __( 'Cost', 'your_text_domain' ),\n\t\t\t\t\t\t'type'              => 'text',\n\t\t\t\t\t\t'class'             => 'wc-shipping-modal-price',\n\t\t\t\t\t\t'placeholder'       => '',\n\t\t\t\t\t\t'description'       => $cost_desc,\n\t\t\t\t\t\t'default'           => '0',\n\t\t\t\t\t\t'desc_tip'          => true,\n\t\t\t\t\t\t'sanitize_callback' => array( $this, 'sanitize_cost' ),\n\t\t\t\t\t),\n\t\t\t\t);\n\n\t\t\t\t/**\n\t\t\t\t * Flat rate shipping has the ability to add rates per shipping class, so here we get the shipping classes and then provide fields\n\t\t\t\t * for merchants/admins to use to be able to specify these costs. \n\t\t\t\t */\n\t\t\t\t$shipping_classes = WC()->shipping()->get_shipping_classes();\n\n\t\t\t\tif ( ! empty( $shipping_classes ) ) {\n\t\t\t\t\t$fields['class_costs'] = array(\n\t\t\t\t\t\t'title'       => __( 'Shipping class costs', 'your_text_domain' ),\n\t\t\t\t\t\t'type'        => 'title',\n\t\t\t\t\t\t'default'     => '',\n\t\t\t\t\t\t/* translators: %s: URL for link */\n\t\t\t\t\t\t'description' => sprintf( __( 'These costs can optionally be added based on the <a target=\"_blank\" href=\"%s\">product shipping class</a>. Learn more about <a target=\"_blank\" href=\"https://woocommerce.com/document/flat-rate-shipping/#shipping-classes\">setting shipping class costs</a>.', 'your_text_domain' ), admin_url( 'admin.php?page=wc-settings&tab=shipping&section=classes' ) ),\n\t\t\t\t\t);\n\t\t\t\t\tforeach ( $shipping_classes as $shipping_class ) {\n\t\t\t\t\t\tif ( ! isset( $shipping_class->term_id ) ) {\n\t\t\t\t\t\t\tcontinue;\n\t\t\t\t\t\t}\n\t\t\t\t\t\t$fields[ 'class_cost_' . $shipping_class->term_id ] = array(\n\t\t\t\t\t\t\t/* translators: %s: shipping class name */\n\t\t\t\t\t\t\t'title'             => sprintf( __( '\"%s\" shipping class cost', 'your_text_domain' ), esc_html( $shipping_class->name ) ),\n\t\t\t\t\t\t\t'type'              => 'text',\n\t\t\t\t\t\t\t'class'             => 'wc-shipping-modal-price',\n\t\t\t\t\t\t\t'placeholder'       => __( 'N/A', 'your_text_domain' ),\n\t\t\t\t\t\t\t'description'       => $cost_desc,\n\t\t\t\t\t\t\t'default'           => $this->get_option( 'class_cost_' . $shipping_class->slug ),\n\t\t\t\t\t\t\t'desc_tip'          => true,\n\t\t\t\t\t\t\t'sanitize_callback' => array( $this, 'sanitize_cost' ),\n\t\t\t\t\t\t);\n\t\t\t\t\t}\n\n\t\t\t\t\t$fields['no_class_cost'] = array(\n\t\t\t\t\t\t'title'             => __( 'No shipping class cost', 'your_text_domain' ),\n\t\t\t\t\t\t'type'              => 'text',\n\t\t\t\t\t\t'class'             => 'wc-shipping-modal-price',\n\t\t\t\t\t\t'placeholder'       => __( 'N/A', 'your_text_domain' ),\n\t\t\t\t\t\t'description'       => $cost_desc,\n\t\t\t\t\t\t'default'           => '',\n\t\t\t\t\t\t'desc_tip'          => true,\n\t\t\t\t\t\t'sanitize_callback' => array( $this, 'sanitize_cost' ),\n\t\t\t\t\t);\n\n\t\t\t\t\t$fields['type'] = array(\n\t\t\t\t\t\t'title'       => __( 'Calculation type', 'your_text_domain' ),\n\t\t\t\t\t\t'type'        => 'select',\n\t\t\t\t\t\t'class'       => 'wc-enhanced-select',\n\t\t\t\t\t\t'default'     => 'class',\n\t\t\t\t\t\t'options'     => array(\n\t\t\t\t\t\t\t'class' => __( 'Per class: Charge shipping for each shipping class individually', 'your_text_domain' ),\n\t\t\t\t\t\t\t'order' => __( 'Per order: Charge shipping for the most expensive shipping class', 'your_text_domain' ),\n\t\t\t\t\t\t),\n\t\t\t\t\t\t'description' => $cost_link,\n\t\t\t\t\t);\n\t\t\t\t}\n\n\t\t\t\t// And finally we set the instance_form_fields property for the Shipping API to use.\n\t\t\t\t$this->instance_form_fields = $fields;\n\t\t\t}\n\t\t}\n\t}\n}\n"})})]})}function p(t={}){const{wrapper:e}={...(0,a.R)(),...t.components};return e?(0,i.jsx)(e,{...t,children:(0,i.jsx)(l,{...t})}):l(t)}},8453:(t,e,n)=>{n.d(e,{R:()=>o,x:()=>r});var s=n(6540);const i={},a=s.createContext(i);function o(t){const e=s.useContext(a);return s.useMemo((function(){return"function"==typeof t?t(e):{...e,...t}}),[e,t])}function r(t){let e;return e=t.disableParentContext?"function"==typeof t.components?t.components(i):t.components||i:o(t.components),s.createElement(a.Provider,{value:e},t.children)}}}]);