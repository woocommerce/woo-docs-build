"use strict";(self.webpackChunkwoo_docs_migration=self.webpackChunkwoo_docs_migration||[]).push([[3326],{3682:(e,t,o)=>{o.r(t),o.d(t,{assets:()=>c,contentTitle:()=>d,default:()=>u,frontMatter:()=>r,metadata:()=>a,toc:()=>i});const a=JSON.parse('{"id":"best-practices/data-management/data-stores","title":"How to manage WooCommerce Data Stores","description":"Introduction","source":"@site/../best-practices/data-management/data-stores.md","sourceDirName":"best-practices/data-management","slug":"/best-practices/data-management/data-stores","permalink":"/docs/best-practices/data-management/data-stores","draft":false,"unlisted":false,"editUrl":"https://github.com/woocommerce/woocommerce/tree/docusaurus-docs-prep/docs/docs/../best-practices/data-management/data-stores.md","tags":[],"version":"current","frontMatter":{"post_title":"How to manage WooCommerce Data Stores","sidebar_label":"Manage data stores"},"sidebar":"docsSidebar","previous":{"title":"Data storage","permalink":"/docs/best-practices/data-management/data-storage"},"next":{"title":"Logging","permalink":"/docs/best-practices/data-management/logging"}}');var n=o(4848),s=o(8453);const r={post_title:"How to manage WooCommerce Data Stores",sidebar_label:"Manage data stores"},d="How to manage WooCommerce Data Stores",c={},i=[{value:"Introduction",id:"introduction",level:2},{value:"Structure",id:"structure",level:2},{value:"Replacing a data store",id:"replacing-a-data-store",level:2},{value:"Creating a new data store",id:"creating-a-new-data-store",level:2},{value:"Defining a new product type",id:"defining-a-new-product-type",level:3},{value:"Data store for custom data",id:"data-store-for-custom-data",level:3},{value:"Calling a data store",id:"calling-a-data-store",level:2},{value:"Data store limitations and WP Admin",id:"data-store-limitations-and-wp-admin",level:2}];function l(e){const t={a:"a",code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",li:"li",p:"p",pre:"pre",ul:"ul",...(0,s.R)(),...e.components};return(0,n.jsxs)(n.Fragment,{children:[(0,n.jsx)(t.header,{children:(0,n.jsx)(t.h1,{id:"how-to-manage-woocommerce-data-stores",children:"How to manage WooCommerce Data Stores"})}),"\n",(0,n.jsx)(t.h2,{id:"introduction",children:"Introduction"}),"\n",(0,n.jsxs)(t.p,{children:["Data store classes act as a bridge between WooCommerce's data CRUD classes (",(0,n.jsx)(t.code,{children:"WC_Product"}),", ",(0,n.jsx)(t.code,{children:"WC_Order"}),", ",(0,n.jsx)(t.code,{children:"WC_Customer"}),", etc) and the database layer. With the database logic separate from data, WooCommerce becomes more flexible. The data stores shipped with WooCommerce core (powered by WordPress' custom posts system and some custom tables) can be swapped out for a different database structure, type, or even be powered by an external API."]}),"\n",(0,n.jsx)(t.p,{children:"This guide will walk through the structure of a data store class, how to create a new data store, how to replace a core data store, and how to call a data store from your own code."}),"\n",(0,n.jsxs)(t.p,{children:["The examples in this guide will look at the ",(0,n.jsx)(t.a,{href:"https://github.com/woocommerce/woocommerce/blob/dcecf0f22890f3cd92fbea13a98c11b2537df2a8/includes/class-wc-coupon.php#L19",children:(0,n.jsx)(t.code,{children:"WC_Coupon"})})," CRUD data class and ",(0,n.jsx)(t.a,{href:"https://github.com/woocommerce/woocommerce/blob/dcecf0f22890f3cd92fbea13a98c11b2537df2a8/includes/data-stores/class-wc-coupon-data-store-cpt.php",children:(0,n.jsx)(t.code,{children:"WC_Coupon_Data_Store_CPT"})}),", an implementation of a coupon data store using WordPress custom post types. This is how coupons are currently stored in WooCommerce."]}),"\n",(0,n.jsxs)(t.p,{children:["The important thing to know about ",(0,n.jsx)(t.code,{children:"WC_Coupon"})," or any other CRUD data class when working with data stores is which props (properties) they contain. This is defined in the ",(0,n.jsx)(t.a,{href:"https://github.com/woocommerce/woocommerce/blob/dcecf0f22890f3cd92fbea13a98c11b2537df2a8/includes/class-wc-coupon.php#L26",children:(0,n.jsx)(t.code,{children:"data"})})," array of each class."]}),"\n",(0,n.jsx)(t.h2,{id:"structure",children:"Structure"}),"\n",(0,n.jsxs)(t.p,{children:["Every data store for a CRUD object should implement the ",(0,n.jsx)(t.code,{children:"WC_Object_Data_Store_Interface"})," interface."]}),"\n",(0,n.jsxs)(t.p,{children:[(0,n.jsx)(t.code,{children:"WC_Object_Data_Store_Interface"})," includes the following methods:"]}),"\n",(0,n.jsxs)(t.ul,{children:["\n",(0,n.jsx)(t.li,{children:(0,n.jsx)(t.code,{children:"create"})}),"\n",(0,n.jsx)(t.li,{children:(0,n.jsx)(t.code,{children:"read"})}),"\n",(0,n.jsx)(t.li,{children:(0,n.jsx)(t.code,{children:"update"})}),"\n",(0,n.jsx)(t.li,{children:(0,n.jsx)(t.code,{children:"delete"})}),"\n",(0,n.jsx)(t.li,{children:(0,n.jsx)(t.code,{children:"read_meta"})}),"\n",(0,n.jsx)(t.li,{children:(0,n.jsx)(t.code,{children:"delete_meta"})}),"\n",(0,n.jsx)(t.li,{children:(0,n.jsx)(t.code,{children:"add_meta"})}),"\n",(0,n.jsx)(t.li,{children:(0,n.jsx)(t.code,{children:"update_meta"})}),"\n"]}),"\n",(0,n.jsxs)(t.p,{children:["The ",(0,n.jsx)(t.code,{children:"create"}),", ",(0,n.jsx)(t.code,{children:"read"}),", ",(0,n.jsx)(t.code,{children:"update"}),", and ",(0,n.jsx)(t.code,{children:"delete"})," methods should handle the CRUD logic for your props:"]}),"\n",(0,n.jsxs)(t.ul,{children:["\n",(0,n.jsxs)(t.li,{children:[(0,n.jsx)(t.code,{children:"create"})," should create a new entry in the database. Example: Create a coupon."]}),"\n",(0,n.jsxs)(t.li,{children:[(0,n.jsx)(t.code,{children:"read"})," should query a single entry from the database and set properties based on the response. Example: Read a coupon."]}),"\n",(0,n.jsxs)(t.li,{children:[(0,n.jsx)(t.code,{children:"update"})," should make changes to an existing entry. Example: Update or edit a coupon."]}),"\n",(0,n.jsxs)(t.li,{children:[(0,n.jsx)(t.code,{children:"delete"})," should remove an entry from the database. Example: Delete a coupon."]}),"\n"]}),"\n",(0,n.jsx)(t.p,{children:"All data stores must implement handling for these methods."}),"\n",(0,n.jsxs)(t.p,{children:["In addition to handling your props, other custom data can be passed. This is considered ",(0,n.jsx)(t.code,{children:"meta"}),". For example, coupons can have custom data provided by plugins."]}),"\n",(0,n.jsxs)(t.p,{children:["The ",(0,n.jsx)(t.code,{children:"read_meta"}),", ",(0,n.jsx)(t.code,{children:"delete_meta"}),", ",(0,n.jsx)(t.code,{children:"add_meta"}),", and ",(0,n.jsx)(t.code,{children:"update_meta"})," methods should be defined so meta can be read and managed from the correct source. In the case of our WooCommerce core classes, we define them in ",(0,n.jsx)(t.code,{children:"WC_Data_Store_WP"})," and then use the same code for all of our data stores. They all use the WordPress meta system. You can redefine these if meta should come from a different source."]}),"\n",(0,n.jsxs)(t.p,{children:["Your data store can also implement other methods to replace direct queries. For example, the coupons data store has a public ",(0,n.jsx)(t.code,{children:"get_usage_by_user_id"})," method. Data stores should always define and implement an interface for the methods they expect, so other developers know what methods they need to write. Put another way, in addition to the ",(0,n.jsx)(t.code,{children:"WC_Object_Data_Store_Interface"})," interface, ",(0,n.jsx)(t.code,{children:"WC_Coupon_Data_Store_CPT"})," also implements ",(0,n.jsx)(t.code,{children:"WC_Coupon_Data_Store_Interface"}),"."]}),"\n",(0,n.jsx)(t.h2,{id:"replacing-a-data-store",children:"Replacing a data store"}),"\n",(0,n.jsxs)(t.p,{children:["Let's look at how we would replace the ",(0,n.jsx)(t.code,{children:"WC_Coupon_Data_Store_CPT"})," class with a ",(0,n.jsx)(t.code,{children:"WC_Coupon_Data_Store_Custom_Table"})," class. Our examples will just provide stub functions, instead of a full working solution. Imagine that we would like to store coupons in a table named ",(0,n.jsx)(t.code,{children:"wc_coupons"})," with the following columns:"]}),"\n",(0,n.jsx)(t.pre,{children:(0,n.jsx)(t.code,{className:"language-text",children:"id, code, amount, date_created, date_modified, discount_type, description, date_expires, usage_count,individual_use, product_ids, excluded_product_ids, usage_limit, usage_limit_per_user, limit_usage_to_x_items, free_shipping, product_categories, excluded_product_categories, exclude_sale_items, minimum_amount, maximum_amount, email_restrictions, used_by\n"})}),"\n",(0,n.jsx)(t.p,{children:"These column names match 1 to 1 with prop names."}),"\n",(0,n.jsx)(t.p,{children:"First we would need to create a new data store class to contain our logic:"}),"\n",(0,n.jsx)(t.pre,{children:(0,n.jsx)(t.code,{className:"language-php",children:"/**\n * WC Coupon Data Store: Custom Table.\n */\nclass WC_Coupon_Data_Store_Custom_Table extends WC_Data_Store_WP implements WC_Coupon_Data_Store_Interface, WC_Object_Data_Store_Interface {\n\n}\n"})}),"\n",(0,n.jsxs)(t.p,{children:["Note that we implement the main ",(0,n.jsx)(t.code,{children:"WC_Object_Data_Store_Interface"})," interface as well as the ",(0,n.jsx)(t.code,{children:" WC_Coupon_Data_Store_Interface"})," interface. Together, these represent all the methods we need to provide logic for."]}),"\n",(0,n.jsx)(t.p,{children:"We would then define the CRUD handling for these properties:"}),"\n",(0,n.jsx)(t.pre,{children:(0,n.jsx)(t.code,{className:"language-php",children:"/**\n * Method to create a new coupon in the database.\n *\n * @param WC_Coupon\n */\npublic function create( &$coupon ) {\n\t$coupon->set_date_created( current_time( 'timestamp' ) );\n\t\n\t/**\n\t * This is where code for inserting a new coupon would go.\n\t * A query would be built using getters: $coupon->get_code(), $coupon->get_description(), etc.\n\t * After the INSERT operation, we want to pass the new ID to the coupon object.\n\t */\n\t$coupon->set_id( $coupon_id );\n\t\n\t// After creating or updating an entry, we need to also cause our 'meta' to save.\n\t$coupon->save_meta_data();\n\t\n\t// Apply changes let's the object know that the current object reflects the database and no \"changes\" exist between the two.\n\t$coupon->apply_changes();\n\t\n\t// It is helpful to provide the same hooks when an action is completed, so that plugins can interact with your data store.\n\tdo_action( 'woocommerce_new_coupon', $coupon_id );\n}\n\n/**\n * Method to read a coupon.\n *\n * @param WC_Coupon\n */\npublic function read( &$coupon ) {\n\t$coupon->set_defaults();\n\n\t// Read should do a check to see if this is a valid coupon\n\t// and otherwise\tthrow an 'Invalid coupon.' exception.\n\t// For valid coupons, set $data to contain our database result.\n\t// All props should be set using set_props with output from the database. This \"hydates\" the CRUD data object.\n\t$coupon_id = $coupon->get_id();\n\t$coupon->set_props( array(\n\t\t'code'                        => $data->code,\n\t\t'description'                 => $data->description,\n\t\t// ..\n\t) );\n\t\n\t\n\t// We also need to read our meta data into the object.\n\t$coupon->read_meta_data();\n\t\n\t// This flag reports if an object has been hydrated or not. If this ends up false, the database hasn't correctly set the object.\n\t$coupon->set_object_read( true );\n\tdo_action( 'woocommerce_coupon_loaded', $coupon );\n}\n\n/**\n * Updates a coupon in the database.\n *\n * @param WC_Coupon\n */\npublic function update( &$coupon ) {\n\t// Update coupon query, using the getters.\n\t\n\t$coupon->save_meta_data();\n\t$coupon->apply_changes();\n\tdo_action( 'woocommerce_update_coupon', $coupon->get_id() );\n}\n\n/**\n * Deletes a coupon from the database.\n *\n * @param WC_Coupon\n * @param array $args Array of args to pass to the delete method.\n */\npublic function delete( &$coupon, $args = array() ) {\n\t// A lot of objects in WordPress and WooCommerce support\n\t// the concept of trashing. This usually is a flag to move the object\n\t// to a \"recycling bin\". Since coupons support trashing, your layer should too.\n\t// If an actual delete occurs, set the coupon ID to 0.\n\t\n\t$args = wp_parse_args( $args, array(\n\t\t'force_delete' => false,\n\t) );\n\n\t$id = $coupon->get_id();\n\n\tif ( $args['force_delete'] ) {\n\t\t// Delete Query\n\t\t$coupon->set_id( 0 );\n\t\tdo_action( 'woocommerce_delete_coupon', $id );\n\t} else {\n\t\t// Trash Query\n\t\tdo_action( 'woocommerce_trash_coupon', $id );\n\t}\n}\n"})}),"\n",(0,n.jsxs)(t.p,{children:["We are extending ",(0,n.jsx)(t.code,{children:"WC_Data_Store_WP"})," so our classes will continue to use WordPress' meta system."]}),"\n",(0,n.jsxs)(t.p,{children:["As mentioned in the structure section, we are responsible for implementing the methods defined by ",(0,n.jsx)(t.code,{children:"WC_Coupon_Data_Store_Interface"}),". Each interface describes the methods and parameters it accepts, and what your function should do."]}),"\n",(0,n.jsx)(t.p,{children:"A coupons replacement would look like the following:"}),"\n",(0,n.jsx)(t.pre,{children:(0,n.jsx)(t.code,{className:"language-php",children:"/**\n * Increase usage count for current coupon.\n * \n * @param WC_Coupon\n * @param string $used_by Either user ID or billing email\n */\npublic function increase_usage_count( &$coupon, $used_by = '' ) {\n\n}\n\n/**\n * Decrease usage count for current coupon.\n * \n * @param WC_Coupon\n * @param string $used_by Either user ID or billing email\n */\npublic function decrease_usage_count( &$coupon, $used_by = '' ) {\n\n}\n\n/**\n * Get the number of uses for a coupon by user ID.\n * \n * @param WC_Coupon\n * @param id $user_id\n * @return int\n */\npublic function get_usage_by_user_id( &$coupon, $user_id ) {\n\n}\n\n/**\n * Return a coupon code for a specific ID.\n * @param int $id\n * @return string Coupon Code\n */\n public function get_code_by_id( $id ) {\n \n }\n\n /**\n  * Return an array of IDs for for a specific coupon code.\n  * Can return multiple to check for existence.\n  * @param string $code\n  * @return array Array of IDs.\n  */\n public function get_ids_by_code( $code ) {\n \n }\n"})}),"\n",(0,n.jsxs)(t.p,{children:["Once all the data store methods are defined and logic written, we need to tell WooCommerce to load our new class instead of the built-in class. This is done using the ",(0,n.jsx)(t.code,{children:"woocommerce_data_stores"})," filter. An array of data store slugs is mapped to default WooCommerce classes. Example:"]}),"\n",(0,n.jsx)(t.pre,{children:(0,n.jsx)(t.code,{className:"language-php",children:"'coupon'              => 'WC_Coupon_Data_Store_CPT',\n'customer'            => 'WC_Customer_Data_Store',\n'customer-download'   => 'WC_Customer_Download_Data_Store',\n'customer-session'    => 'WC_Customer_Data_Store_Session',\n'order'               => 'WC_Order_Data_Store_CPT',\n'order-refund'        => 'WC_Order_Refund_Data_Store_CPT',\n'order-item'          => 'WC_Order_Item_Data_Store',\n'order-item-coupon'   => 'WC_Order_Item_Coupon_Data_Store',\n'order-item-fee'      => 'WC_Order_Item_Fee_Data_Store',\n'order-item-product'  => 'WC_Order_Item_Product_Data_Store',\n'order-item-shipping' => 'WC_Order_Item_Shipping_Data_Store',\n'order-item-tax'      => 'WC_Order_Item_Tax_Data_Store',\n'payment-token'       => 'WC_Payment_Token_Data_Store',\n'product'             => 'WC_Product_Data_Store_CPT',\n'product-grouped'     => 'WC_Product_Grouped_Data_Store_CPT',\n'product-variable'    => 'WC_Product_Variable_Data_Store_CPT',\n'product-variation'   => 'WC_Product_Variation_Data_Store_CPT',\n'shipping-zone'       => 'WC_Shipping_Zone_Data_Store',\n"})}),"\n",(0,n.jsx)(t.p,{children:"We specifically want to target the coupon data store, so we would do something like this:"}),"\n",(0,n.jsx)(t.pre,{children:(0,n.jsx)(t.code,{className:"language-php",children:"function myplugin_set_wc_coupon_data_store( $stores ) {\n\t$stores['coupon'] = 'WC_Coupon_Data_Store_Custom_Table';\n\treturn $stores;\n}\n\nadd_filter( 'woocommerce_data_stores', 'myplugin_set_wc_coupon_data_store' );\n"})}),"\n",(0,n.jsxs)(t.p,{children:["Our class would then be loaded by WooCommerce core, instead of ",(0,n.jsx)(t.code,{children:"WC_Coupon_Data_Store_CPT"}),"."]}),"\n",(0,n.jsx)(t.h2,{id:"creating-a-new-data-store",children:"Creating a new data store"}),"\n",(0,n.jsx)(t.h3,{id:"defining-a-new-product-type",children:"Defining a new product type"}),"\n",(0,n.jsx)(t.p,{children:"Does your extension create a new product type? Each product type has a data store in addition to a parent product data store. The parent store handles shared properties like name or description and the child handles more specific data."}),"\n",(0,n.jsx)(t.p,{children:'For example, the external product data store handles "button text" and "external URL". The variable data store handles the relationship between parent products and their variations.'}),"\n",(0,n.jsxs)(t.p,{children:["Check out ",(0,n.jsx)(t.a,{href:"https://developer.woocommerce.com/2017/02/06/wc-2-7-extension-compatibility-examples-3-bookings/",children:"this walkthrough"})," for more information on this process."]}),"\n",(0,n.jsx)(t.h3,{id:"data-store-for-custom-data",children:"Data store for custom data"}),"\n",(0,n.jsx)(t.p,{children:"If your extension introduces a new database table, new custom post type, or some new form of data not related to products, orders, etc, then you should implement your own data store."}),"\n",(0,n.jsxs)(t.p,{children:["Your data store should still implement ",(0,n.jsx)(t.code,{children:"WC_Object_Data_Store_Interface"})," and provide the normal CRUD functions. Your data store should be the main point of entry for interacting with your data, so any other queries or operations should also have methods."]}),"\n",(0,n.jsxs)(t.p,{children:["The ",(0,n.jsx)(t.a,{href:"https://github.com/woocommerce/woocommerce/blob/trunk/plugins/woocommerce/includes/data-stores/class-wc-shipping-zone-data-store.php",children:"shipping zone data store"}),' serves as a good example for a "simple" data store using a custom table. The coupons code is a good example for a data store using a custom post type.']}),"\n",(0,n.jsxs)(t.p,{children:["All you need to do to register your data store is add it to the ",(0,n.jsx)(t.code,{children:"woocommerce_data_stores"})," filter:"]}),"\n",(0,n.jsx)(t.pre,{children:(0,n.jsx)(t.code,{className:"language-php",children:"function myplugin_set_my_custom_data_store( $stores ) {\n\t$stores['mycustomdata'] = 'WC_My_Custom_Data_Store';\n\treturn $stores;\n}\n\nadd_filter( 'woocommerce_data_stores', 'myplugin_set_my_custom_data_store' );\n"})}),"\n",(0,n.jsx)(t.p,{children:"You can then load your data store like any other WooCommerce data store."}),"\n",(0,n.jsx)(t.h2,{id:"calling-a-data-store",children:"Calling a data store"}),"\n",(0,n.jsxs)(t.p,{children:["Calling a data store is as simple as using the static ",(0,n.jsx)(t.code,{children:"WC_Data_Store::load()"})," method:"]}),"\n",(0,n.jsx)(t.pre,{children:(0,n.jsx)(t.code,{className:"language-php",children:"// Load the shipping zone data store.\n$data_store = WC_Data_Store::load( 'shipping-zone' );\n// Get the number of shipping methods for zone ID 4.\n$num_of_methods = $data_store->get_method_count( 4 );\n"})}),"\n",(0,n.jsx)(t.p,{children:"You can also chain methods:"}),"\n",(0,n.jsx)(t.pre,{children:(0,n.jsx)(t.code,{className:"language-php",children:"// Get the number of shipping methods for zone ID 4.\n$num_of_methods = WC_Data_Store::load( 'shipping-zone' )->get_method_count( 4 );\n"})}),"\n",(0,n.jsxs)(t.p,{children:["The ",(0,n.jsx)(t.code,{children:"::load()"})," method works for any data store registered to ",(0,n.jsx)(t.code,{children:"woocommerce_data_stores"}),", so you could load your custom data store:"]}),"\n",(0,n.jsx)(t.pre,{children:(0,n.jsx)(t.code,{className:"language-php",children:"$data_store = WC_Data_Store::load( 'mycustomdata' );\n"})}),"\n",(0,n.jsx)(t.h2,{id:"data-store-limitations-and-wp-admin",children:"Data store limitations and WP Admin"}),"\n",(0,n.jsx)(t.p,{children:"Currently, several WooCommerce screens still rely on WordPress to list objects. Examples of this include coupons and products."}),"\n",(0,n.jsxs)(t.p,{children:["If you replace data via a data store, some parts of the existing UI may fail. An example of this may be lists of coupons when using the ",(0,n.jsx)(t.code,{children:"type"})," filter. This filter uses meta data, and is in turn passed to WordPress which runs a query using the ",(0,n.jsx)(t.code,{children:"WP_Query"})," class. This cannot handle data outside of the regular meta tables (Ref #19937). To get around this, usage of ",(0,n.jsx)(t.code,{children:"WP_Query"})," would need to be deprecated and replaced with custom query classes and functions."]})]})}function u(e={}){const{wrapper:t}={...(0,s.R)(),...e.components};return t?(0,n.jsx)(t,{...e,children:(0,n.jsx)(l,{...e})}):l(e)}},8453:(e,t,o)=>{o.d(t,{R:()=>r,x:()=>d});var a=o(6540);const n={},s=a.createContext(n);function r(e){const t=a.useContext(s);return a.useMemo((function(){return"function"==typeof e?e(t):{...t,...e}}),[t,e])}function d(e){let t;return t=e.disableParentContext?"function"==typeof e.components?e.components(n):e.components||n:r(e.components),a.createElement(s.Provider,{value:t},e.children)}}}]);